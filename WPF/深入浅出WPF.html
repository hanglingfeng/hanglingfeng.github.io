<!DOCTYPE html><html><head>
      <title>深入浅出WPF</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\Hang\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.13\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="前言">前言 </h1>
<ul>
<li>什么是WPF<br>
当今大部分程序都是多层架构，一般至少包含3层：</li>
</ul>
<blockquote>
<p>数据层：用于存储数据，多由数据库构成，有时也用数据文件辅助存储。例如医院的药品列表、人员列表、病例列表都存储在这一层。</p>
</blockquote>
<blockquote>
<p>业务逻辑层：用于根据需求使用计算机程序表达现实业务的逻辑。例如哪些医生可以给哪些病人看病、从挂号到取药有什么流程、从住院到出院有什么流程，都可以由这层实现。这一层一般会通过一组服务(Service)向表示层公开自己的各个功能。因为这一层需要与数据层进行交互，所以常划分出一个“数据访问层(Data Access Layer, DAL)”的子层专门负责数据的存取。</p>
</blockquote>
<blockquote>
<p>表示层：负责把数据和流程展示给用户看。对于同一组来自业务逻辑层的数据，我们可以选择多种表达方式。例如对于同一张药品单，可用字符串形式、表格形式来展现。表示层还负责展示流程、响应用户操作等。表示层程序也常被称为客户端程序。</p>
</blockquote>
<p>WPF的功能就是用来编写应用程序的表示层，业务逻辑层可使用WCF和WF技术。无论使用哪种技术作为表示层技术，程序的逻辑层和数据层都是相同的。</p>
<ul>
<li>为什么学习WPF<br>
只要开发表示层程序，就不可避免地要与4种功能性代码打交道：</li>
</ul>
<blockquote>
<p>数据模型：现实世界中事物和逻辑的抽象。<br>
业务逻辑：数据模型之间的关系与交互。<br>
界面逻辑：控件与控制之间的关系与交互。<br>
用户界面：由控件构成的、与用户进行交互的界面，用于向用户展示数据、响应用户输入。</p>
</blockquote>
<p>这4种功能性代码关系如下：<br>
用户界面 &lt;<mark>&gt; 界面逻辑 &lt;</mark>&gt; 业务逻辑 &lt;==&gt; 数据模型</p>
<p>在保持代码可维护性的前提下，如何让数据顺畅地到达用户界面并灵活显示，同时方便地接手用户操作，这历来都是表示层开发的核心问题。有经久不衰的MVC模式、MVP模式。WinForm、ASP.NET均使用“事件驱动”理念，这种由“事件-订阅-事件处理器”关系交织在一起构成的程序，尽管可以用MVC、MVP等设计模式，但一不小心就会使界面逻辑和业务逻辑纠缠在一起，使代码复杂难懂。WPF则使用“数据驱动”理念。</p>
<p>事件驱动时代，用户每进行一个操作会激发程序发生一个事件，事件发生后，事件处理器就会执行。事件处理器是一个方法，在这个方法中，程序员可以处理数据或调用别的方法，这样程序就在事件的驱动下向前执行了。可见事件驱动时代数据是静态的、被动的，界面是主动的、界面逻辑与业务逻辑之间的桥梁是事件。</p>
<p>数据驱动正好相反，当数据发生变化时，会主动通知界面控件、推动控件展示最新数据，同时用户对控件的操作会直接送达数据，就好像控件是透明的。可见数据驱动理念中数据占主动地位，控件和控件事件被弱化，控件事件一般只参与界面逻辑，不再染指业务逻辑，这使得程序复杂度得到有效控制。数据与界面之间的桥梁是数据关联(Data Binding、Data Template、Control Template等)，通过这个桥梁，数据可以流向界面，再从界面流回数据。</p>
<p>使用WPF开发较之WinForm开发更简单，程序更加简洁清晰。</p>
<h1 id="xaml概览">XAML概览 </h1>
<h2 id="xaml是什么">XAML是什么 </h2>
<p>网络开发团队的工作大致如下：草图产生后，设计师使用HTML、CSS、JavaScript直接生成UI，程序员则在这个UI生成的同时实现它背后的功能逻辑。有经验的设计师和程序员往往还具备互换工具的能力，因此他们能基于HTML、CSS、JavaScript这个平台进行有效沟通。</p>
<p>XAML也是如此，它在桌面开发中扮演了HTML、CSS、JavaScript这个角色，成为设计师与程序员沟通的枢纽。设计师使用Blend设计UI，程序员使用VS开发后台逻辑代码。UI以XAML形式直接保存进项目，节省了沟通成本。</p>
<p>简单来说，XAML是WPF中专门用来设计UI的语言。</p>
<h2 id="xaml的优点">XAML的优点 </h2>
<blockquote>
<p>好用：可以设计出专业的UI和动画。<br>
易学：不需要专业的编程知识，它结构清晰，简单易懂。<br>
高效：使得设计师能直接参与软件开发，随时沟通，无需二次转化。</p>
</blockquote>
<p>程序员们一致追求将视图(View，也就是UI)与逻辑代码分离，以往的开发模式中，很难保证UI代码完全不与逻辑代码纠缠(称为UI与逻辑的紧耦合)。UI与逻辑的紧耦合后果如下：</p>
<blockquote>
<p>无论软件功能还是UI设计有所变化或出bug，都将导致大量代码修改。<br>
逻辑代码更加难以理解，读懂并修改代码往往比重写更困难。<br>
重用代码逻辑变为不可能。</p>
</blockquote>
<p>XAML的另一个巨大优点是真正实现了UI与逻辑的剥离。XAML是一种单纯的声明性语言，只能用来声明一些UI元素、绘制UI和动画(XAML里动画无需编程即可实现)，根本无法在其中加入程序逻辑，这就强制地把逻辑代码从UI代码中赶走了。这样，与UI相关的代码位于程序UI层，与逻辑相关的代码位于程序逻辑层，形成了一种“高内聚-低耦合”的结构。因此无论是对UI做较大改动或是重用底层逻辑，都不会费太大力气。</p>
<h1 id="从零起步认识xaml">从零起步认识XAML </h1>
<p>新建一个.NET4.8的WPF应用程序，其MainWindow.xaml文件内容如下：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window</span> <span class="token attr-name"><span class="token namespace">x:</span>Class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Net4._8WpfApp1.MainWindow<span class="token punctuation">"</span></span>
        <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml/presentation<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>d</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/expression/blend/2008<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>mc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.openxmlformats.org/markup-compatibility/2006<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>local</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:Net4._8WpfApp1<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">mc:</span>Ignorable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>d<span class="token punctuation">"</span></span>
        <span class="token attr-name">Title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MainWindow<span class="token punctuation">"</span></span> <span class="token attr-name">Height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>450<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>800<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>XAML语言是从XML语言派生出来的，XML语言有一个功能，可以在XML文档标签上使用xmlns特征(attribute)来定义名称空间，xmlns是XML-namespace的缩写。定义名称空间的好处是，当来源不同的类重名时，可使用名称空间加以区分。xmlns特征的语法格式如下：</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>xmlns[:可选的映射前缀]="名称空间"
</code></pre><p>如果没有映射前缀，意味着这个名称空间是默认名称空间，所有来自默认名称空间的标签都不用加前缀。默认名称空间只能有一个，应该选择其中元素被使用最频繁的名称空间来作为默认名称空间。上例中，Window和Grid都来自默认名称空间，而第1行的Class特征则来自于第3行中x前缀对应的名称空间。这里做一个实验，如果给第2行的名称空间加一个前缀n，那么Window和Grid也要加前缀n才能通过编译：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">n:</span>Window</span> <span class="token attr-name"><span class="token namespace">x:</span>Class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Net4._8WpfApp1.MainWindow<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>n</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml/presentation<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>d</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/expression/blend/2008<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>mc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.openxmlformats.org/markup-compatibility/2006<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>local</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:Net4._8WpfApp1<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">mc:</span>Ignorable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>d<span class="token punctuation">"</span></span>
        <span class="token attr-name">Title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MainWindow<span class="token punctuation">"</span></span> <span class="token attr-name">Height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>450<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>800<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">n:</span>Grid</span><span class="token punctuation">&gt;</span></span>        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">n:</span>Grid</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">n:</span>Window</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>如果想在C#代码中引用外来程序集，首先添加程序集引用，然后写using指令引入名称空间。XAML中也类似，首先引用程序集，然后在根元素的起始标签中写上一句xmlns来定义名称空间，下例要引用PresentationFramework.dll中的System.Windows.Controls.Button类，定义了前缀为c的名称空间，引用Button时也要加前缀c。同时由于默认名称空间已经引入了包括PresentationFramework.dll在内的很多程序集，所以Button也可以不加前缀：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window</span> <span class="token attr-name"><span class="token namespace">x:</span>Class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Net4._8WpfApp1.MainWindow<span class="token punctuation">"</span></span>
        <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml/presentation<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>d</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/expression/blend/2008<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>mc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.openxmlformats.org/markup-compatibility/2006<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>c</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:System.Windows.Controls;assembly=PresentationFramework<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>local</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:Net4._8WpfApp1<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">mc:</span>Ignorable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>d<span class="token punctuation">"</span></span>
        <span class="token attr-name">Title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MainWindow<span class="token punctuation">"</span></span> <span class="token attr-name">Height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>450<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>800<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">c:</span>Button</span><span class="token punctuation">&gt;</span></span>OK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">c:</span>Button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span><span class="token punctuation">&gt;</span></span>OK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>第1个名称空间xmlns="<a href="http://schemas.microsoft.com/winfx/2006/xaml/presentation">http://schemas.microsoft.com/winfx/2006/xaml/presentation</a>"对应的是与绘制UI相关的程序集，是表示层面上的东西，其名字中带有presentation一词也可见一斑。</p>
<p>第2个名称空间xmlns:x="<a href="http://schemas.microsoft.com/winfx/2006/xaml">http://schemas.microsoft.com/winfx/2006/xaml</a>"对应一些与XAML语法和编译相关的CLR名称空间，让XAML语言解析处理相关程序集，是语言层面上的东西。</p>
<p>x:Class="Net4._8WpfApp1.MainWindow"这个特征(Attribute)的作用是当XAML解析器将包含它的标签(此处是Window)解析成C#类后，它的类名是什么，并和对应部分类合并。</p>
<p>App.xaml文件内容如下：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Application</span> <span class="token attr-name"><span class="token namespace">x:</span>Class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Net4._8WpfApp1.App<span class="token punctuation">"</span></span>
             <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml/presentation<span class="token punctuation">"</span></span>
             <span class="token attr-name"><span class="token namespace">xmlns:</span>x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml<span class="token punctuation">"</span></span>
             <span class="token attr-name"><span class="token namespace">xmlns:</span>local</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:Net4._8WpfApp1<span class="token punctuation">"</span></span>
             <span class="token attr-name">StartupUri</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MainWindow.xaml<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Application.Resources</span><span class="token punctuation">&gt;</span></span>            
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Application.Resources</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Application</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>注意其中有一句StartupUri="MainWindow.xaml"，这告诉编译器把由MainWindow.xaml解析后生成的窗体作为程序启动时的主窗体。只要MainWindow.xaml能解析为一个窗体，程序就能正常运行。</p>
<p>做个实验，将MainWindow.xaml中的x:Class="Net4._8WpfApp1.MainWindow"改为x:Class="Net4._8WpfApp1.MainWindowABC"，同时删除MainWindow.cs文件，程序依然可以正常运行，通过dnspy可查看到生成了MainWindowABC类。<br>
<img src="2023-02-11-12-06-06.png" alt=""></p>
<h1 id="系统学习xaml语法">系统学习XAML语法 </h1>
<h2 id="xaml文档的树形结构">XAML文档的树形结构 </h2>
<p>XAML文档基本以Window对象为根节点，一层层向下包含，这种树形结构深刻影响着WPF的属性(Property)子系统和事件(Event)子系统。在实践编程中，我们经常需要在这棵树上进行按名称查找元素、获取父子节点等操作。为了方便操作这棵树，WPF基本类库里提供了VisualTreeHelper和LogicalTreeHelper两个助手类(Helper Class)，同时在一些重要的基类里封装了一些专门用于操作这棵树的方法。</p>
<h2 id="xaml中为对象属性赋值的语法">XAML中为对象属性赋值的语法 </h2>
<p>XAML中为对象属性赋值有2种方法：</p>
<blockquote>
<p>使用字符串进行简单赋值<br>
使用属性元素(Property Element)进行复杂赋值</p>
</blockquote>
<h3 id="使用标签的attribute为对象属性赋值">使用标签的Attribute为对象属性赋值 </h3>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Rectangle</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rect<span class="token punctuation">"</span></span> <span class="token attr-name">Fill</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Blue<span class="token punctuation">"</span></span> <span class="token attr-name">Height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>200<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Rectangle</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-11-14-44-42.png" alt=""></p>
<p>Rectangle中Fill的类型是Brush，字符串"Blue"最终被翻译为SolidColorBrush对象，用C#代码表示是这样：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>Fill <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">SolidColorBrush</span><span class="token punctuation">(</span>Colors<span class="token punctuation">.</span>Blue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>通过这种Attribute=Value的语法进行赋值时，Value只能是字符串值，这就引出了2个问题：</p>
<ol>
<li>如果一个类能用XAML语言声明，并允许它的Property与XAML标签的Attribute互相映射，那就需要为这些Property准备适当的转换机制。</li>
<li>由于Value是个字符串，所以其复杂程度有限，如何设计让字符串转换成复杂的目标对象呢？</li>
</ol>
<p>第1个问题的解决方案是使用TypeConverter类的派生类并重写TypeConverter的一些方法。<br>
第2个问题的解决方案是使用属性元素(Property Element)。</p>
<h3 id="使用typeconverter类将xaml标签的attribute与对象的property进行映射">使用TypeConverter类将XAML标签的Attribute与对象的Property进行映射 </h3>
<p>现有这样的类：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">Human</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name">Human</span> Child <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>想在XAML中这样写，期望能给Human类实例的Child属性赋一个Human类的值，且Child.Name就是这个字符串的值"Tom"：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>Human</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>human<span class="token punctuation">"</span></span> <span class="token attr-name">Child</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Tom<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword keyword-var">var</span></span> human <span class="token operator">=</span> <span class="token punctuation">(</span>Human<span class="token punctuation">)</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">FindResource</span><span class="token punctuation">(</span><span class="token string">"human"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//异常，无法转换</span>
        MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>human<span class="token punctuation">.</span>Child<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p>为了将字符串转化为对象，可以使用TypeConverter和TypeConverterAttribute两个类。<br>
先从TypeConverter派生出一个类，重写相关方法：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">StringToHumanConverter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">TypeConverter</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-override">override</span> <span class="token return-type class-name"><span class="token keyword keyword-object">object</span></span> <span class="token function">ConvertFrom</span><span class="token punctuation">(</span><span class="token class-name">ITypeDescriptorContext</span> context<span class="token punctuation">,</span> <span class="token class-name">CultureInfo</span> culture<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-value">value</span> <span class="token keyword keyword-is">is</span> <span class="token class-name"><span class="token keyword keyword-string">string</span></span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//参数value就是我们在XAML文档中设置的值</span>
                <span class="token class-name">Human</span> human <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Human</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> str <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-return">return</span> human<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-base">base</span><span class="token punctuation">.</span><span class="token function">ConvertFrom</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> culture<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//其它方法按需重载，具体参考类库文档</span>
    <span class="token punctuation">}</span>
</code></pre><p>但这还不够，还需要使用TypeConverterAttribute这个特征类把StringToHumanConverter类“粘贴”到Human类上：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token comment">//这里可以省略Attribute后缀，但要认清使用的是TypeConverterAttribute类，而非TypeConverter类。</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">TypeConverterAttribute</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">StringToHumanConverter</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword keyword-class">class</span> <span class="token class-name">Human</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name">Human</span> Child <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>单击按钮，效果如下：<br>
<img src="2023-02-11-15-30-22.png" alt=""></p>
<h3 id="属性元素">属性元素 </h3>
<p>XAML中非空标签都有自己的内容(Content)，标签内容就是起始标签和结束标签之间的一些子级标签，每个子级标签都是父级标签内容的一个元素(Element)，属性元素就是以元素形式表达一个实例的属性。改写之前Rectangle的例子：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Rectangle</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rect<span class="token punctuation">"</span></span> <span class="token attr-name">Height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>200<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Rectangle.Fill</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SolidColorBrush</span> <span class="token attr-name">Color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Blue<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Rectangle.Fill</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Rectangle</span><span class="token punctuation">&gt;</span></span>   
</code></pre><p>这种语法应用于复杂对象时很有用，例如：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Rectangle</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rect<span class="token punctuation">"</span></span> <span class="token attr-name">Height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>200<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Rectangle.Fill</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearGradientBrush</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearGradientBrush.GradientStops</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GradientStop</span> <span class="token attr-name">Offset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.2<span class="token punctuation">"</span></span> <span class="token attr-name">Color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>LightBlue<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GradientStop</span> <span class="token attr-name">Offset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.7<span class="token punctuation">"</span></span> <span class="token attr-name">Color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Blue<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GradientStop</span> <span class="token attr-name">Offset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1.0<span class="token punctuation">"</span></span> <span class="token attr-name">Color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>DarkBlue<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearGradientBrush.GradientStops</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearGradientBrush</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Rectangle.Fill</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Rectangle</span><span class="token punctuation">&gt;</span></span>  
</code></pre><p><img src="2023-02-11-15-42-36.png" alt=""></p>
<h3 id="标记扩展markup-extensions">标记扩展(Markup Extensions) </h3>
<p>大多数赋值都是为属性生成一个新对象，但有时候需要把同一个对象赋值给两个对象的属性，有时候需要给对象的属性赋值为null，还有时候需要将一个对象的属性值依赖在其它对象的某个属性上。当需要进行这些特殊赋值时，就需要使用标记扩展了。</p>
<p>所谓标记扩展，实际上是一种特殊的Attribute=Value语法，其中Value字符串是由一对花括号及其括起来的内容组成，XAML编译器会对这样的内容做出解析，生成相应对象。</p>
<p>使用Binding类的实例将TextBox的Text属性依赖在Slider的Value上，这样当Slider的滑块移动时，TextBox会显示Slider的当前值：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Slider</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Slider</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding ElementName=slider, Path=Value, Mode=OneWay}<span class="token punctuation">"</span></span> <span class="token attr-name">Margin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- 也可以用属性标签的形式来替换标记扩展，只是不够简洁 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox.Text</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Binding</span> <span class="token attr-name">ElementName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Value<span class="token punctuation">"</span></span> <span class="token attr-name">Mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>OneWay<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox.Text</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>其中，Text="{Binding ElementName=slider, Path=Value, Mode=OneWay}"这句是标记扩展，分析如下：</p>
<blockquote>
<p>编译器看到这句代码时，会把花括号里的内容解析成对象.<br>
对象的数据类型是紧邻左花括号的字符串，即Binding。<br>
对象的属性由一串以逗号连接的子字符串负责初始化，注意，属性值不再加引号。</p>
</blockquote>
<p>只有MarkupExtension类的派生类才能使用标记扩展语法来创建对象。</p>
<p>使用标记扩展时要注意以下几点：</p>
<blockquote>
<p>标记扩展可以嵌套，例如：</p>
</blockquote>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>Human</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>human<span class="token punctuation">"</span></span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fatherName<span class="token punctuation">"</span></span> <span class="token attr-name">Child</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Tom<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Source={StaticResource human}, Path=Name}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><blockquote>
<p>扩展标记可以简写，例如：</p>
</blockquote>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Slider</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Slider</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- 等价 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Value, ElementName=slider, Mode=OneWay}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Value, ElementName=slider, Mode=OneWay}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
        

        <span class="token comment">&lt;!-- 等价 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Source={StaticResource human}, Path=Name}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Source={StaticResource  ResourceKey=human}, Path=Name}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>这两种写法中，前者称为固定位置参数(Positional Parameter)，后者称为具名参数(Named Parameters)。固定位置参数实际就是标记扩展类构造器的参数，其位置由构造器参数列表决定。</p>
<blockquote>
<p>标记扩展类的类名以Extension结尾，在XAML中使用时可省略Extension后缀：</p>
</blockquote>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token comment">&lt;!-- 等价 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Source={StaticResource  ResourceKey=human}, Path=Name}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Source={StaticResourceExtension  ResourceKey=human}, Path=Name}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><h2 id="导入程序集和引用其中的名称空间">导入程序集和引用其中的名称空间 </h2>
<p>大多数情况下，根据架构设计，一个程序会被分成若干个相对独立的模块来编写，每个模块可独立编译、进行版本升级。模块之间会存在一些依赖关系，即有些模块需要借用其它模块中的功能。.NET的模块称为程序集(Assembly)，例如用VS新建一个解决方案，解决方案中会包含若干个项目，每个项目的编译结果就是一个程序集。常见的程序集以exe或dll为后缀名，<a href="http://xn--6kqu55g.NET">由于.NET</a> API以类和类级别的单元为主，所以我们也常把引用程序集说成引用类库。</p>
<p>导入程序集和引用其中的名称空间在上文已经演示过，不再赘述。</p>
<h1 id="x名称空间详解">x名称空间详解 </h1>
<h2 id="x名称空间里有什么">X名称空间里有什么 </h2>
<p>x名称空间里的成员(例如x:Name、x:Class)是专门写给XAML编译器看的，用来引导XAML编译器把XAML代码解析编译成中间语言，存储在程序集中。在解析编译XAML的过程中，我们经常需要告诉编译器一些重要信息，例如XAML代码的编译结果和哪个C#代码的编译结果合并、使用XAML声明的元素是public还是private等。这些与XAML编译器沟通的工具都存放在x名称空间中。</p>
<h2 id="x名称空间中的attribute">x名称空间中的Attribute </h2>
<p>前面我们已经知道Attribute和Property是两个层面的东西。Attribute是语言层面的、给编译器看的，Property是面向对象层面的、给编程逻辑用的。例如x:Class="目标类名"这样一个Attribute告诉编译器要和哪个类合并，x:Class这个Attribute并不是对象成员，而是我们把它从x名称空间拿出来硬贴上去的。</p>
<p>下面我们来看看常用Attribute。</p>
<h3 id="xclass">x:Class </h3>
<p>这个Attribute告诉XAML编译器将XAML标签的编译结果与后台代码中指定的类合并。使用x:Class时必须遵循以下要求：</p>
<blockquote>
<p>x:Class只能用于根节点。<br>
该根节点的类型要与x:Class的值所指示的类型保持一致。<br>
x:Class的值所指示的类型在声明时必须使用partial关键字。</p>
</blockquote>
<h3 id="xclassmodifier">x:ClassModifier </h3>
<p>这个Attribute告诉XAML编译器由标签生成的类具有怎样的访问控制级别。使用x:ClassModifier要注意：</p>
<blockquote>
<p>标签必须具有x:Class。<br>
x:ClassModifier的值必须与x:Class所指示类的访问控制级别一致。<br>
x:ClassModifier的值随后台代码的编译语言不同而不同，参见TypeAttributes枚举类型。</p>
</blockquote>
<p>例如新建一个WPF应用程序并编译，用dnspy打开，可观察到MainWindow类是public访问权限。下面修改XAML标记：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window</span> <span class="token attr-name"><span class="token namespace">x:</span>Class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Net4._8WpfApp1.MainWindow<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">x:</span>ClassModifier</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>internal<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>此时编译会收到一个编译错误，因为C#代码里MainWindow是public访问权限。只需将C#代码中MainWindow的访问权限从public改为internal，编译即可通过。再用dnspy打开，可观察到MainWindow类是internal访问权限。</p>
<h3 id="xname">x:Name </h3>
<p>x:Name作用有两个：</p>
<blockquote>
<p>告诉XAML编译器，为这个标签创建一个引用变量，变量名就是x:Name所设置的值。<br>
将这个标签所对应对象的Name属性(如果有的话)也设为x:Name所设置的值，并把这个值注册到UI树上，方便查找。</p>
</blockquote>
<p>一个XAML标签就声明了一个对象，这个对象一般是某控件的实例。如何在代码中访问这个对象呢？看下面的例子：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span><span class="token punctuation">&gt;</span></span>hello world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">Click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Button_Click<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>OK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>我们可以通过层级关系来找到我们最终想要的控件：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StackPanel</span> stackPanel <span class="token operator">=</span> <span class="token punctuation">(</span>StackPanel<span class="token punctuation">)</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>Content<span class="token punctuation">;</span>
        <span class="token class-name">TextBox</span> textBox <span class="token operator">=</span> <span class="token punctuation">(</span>TextBox<span class="token punctuation">)</span>stackPanel<span class="token punctuation">.</span>Children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-string">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>textBox<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"No Name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>textBox<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>不过这种方法有些繁琐，如果我们需要为对象准备一个引用变量并在代码中直接访问，那就必须显式告诉XAML编译器，使用x:Name可为这个对象声明变量：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>hello world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>之后可直接引用txtBox这个变量访问对应的实例：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-string">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>txtBox<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"No Name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>txtBox<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-02-12-14-22-00.png" alt=""></p>
<p>单击按钮后弹窗出现字符串"txtBox"，说明x:Name不但让编译器声明了引用变量，而且将实例的Name属性也赋值为字符串"txtBox"。使用dnspy查看，发了Window类中多了一个成员：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Window</span><span class="token punctuation">,</span> <span class="token class-name">IComponentConnector</span></span> <span class="token punctuation">{</span>
        <span class="token comment">//...</span>

        <span class="token keyword keyword-internal">internal</span> <span class="token class-name">TextBox</span> txtBox<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p>注意，如果一个标签对应的实例没有Name这个成员，那么x:Name的作用就只剩下让编译器为这个实例创建引用变量了。通常在XAML代码中写x:Name和Name是一样的，除非该对象没有Name属性，那就只能写为x:Name。因为x:Name涵盖了Name属性的功能，所以全部使用x:Name可增强代码的一致性和可读性。</p>
<h3 id="xfieldmodifier">x:FieldModifier </h3>
<p>从上文可知，使用x:Name后，对应的实例就有了自己的引用变量，这些变量都是类的字段，访问级别是internal。有时我们需要从一个程序集访问另一个程序集窗体中的元素，这就需要把目标元素的引用变量设置为public。x:FieldModifier可在XAML中设置引用变量的访问级别：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">x:</span>FieldModifier</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>public<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>hello world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>使用dnspy打开，可观察到是public权限：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Window</span><span class="token punctuation">,</span> <span class="token class-name">IComponentConnector</span></span> <span class="token punctuation">{</span>
        <span class="token comment">//...</span>

        <span class="token keyword keyword-public">public</span> <span class="token class-name">TextBox</span> txtBox<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><h3 id="xkey">x:Key </h3>
<p>最自然的检索方式莫过于key-value的形式了，在XAML中我们可以把需要多次使用的内容放在资源字典(Resource Dictionary)里，需要使用该资源时就用它的key将其检索出来。</p>
<p>x:Key的作用就是为资源贴上用于检索的索引。几乎每个WPF元素都有自己的Resources属性，这个属性是key-value式的集合。只要把元素放进这个集合，该元素就成为集合中的一个条目，可通过Key将其索引出来。</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window</span> <span class="token attr-name"><span class="token namespace">x:</span>Class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Net4._8WpfApp1.MainWindow<span class="token punctuation">"</span></span>       
        <span class="token attr-name"><span class="token namespace">xmlns:</span>local</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:Net4._8WpfApp1<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>sys</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:System;assembly=mscorlib<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">sys:</span>String</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myString<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>hello world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">sys:</span>String</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{StaticResource myString}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">Click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Button_Click<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>OK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-12-14-51-56.png" alt=""></p>
<p>程序一运行即可观察到TextBox中已经显示了资源字符串的值。</p>
<p>也可以通过代码检索资源，检索到之后将其恢复成正确的数据类型就可使用了：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword keyword-string">string</span></span> str <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span><span class="token function">FindResource</span><span class="token punctuation">(</span><span class="token string">"myString"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-02-12-14-54-19.png" alt=""></p>
<h3 id="xshared">x:Shared </h3>
<p>默认情况下，我们通过x:Key检索出来的对象都是同一个对象，如果将资源设置为x:Shared="false"，那么我们每次检索都会得到这个对象的一个新副本。XAML编译器默认将资源设置为x:Shared="true"，即每次检索得到同一个对象。</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">sys:</span>String</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myString<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">x:</span>Shared</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>hello world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">sys:</span>String</span><span class="token punctuation">&gt;</span></span>
</code></pre><h2 id="x名称空间中的标记扩展">x名称空间中的标记扩展 </h2>
<p>前面说过标记扩展(Markup Extension)是实际上是MarkupExtension类的直接或间接派生类。x名称空间中包含有这样一些类，所以常称它们为x名称空间内的标记扩展。下面看看常用的标记扩展。</p>
<h3 id="xtype">x:Type </h3>
<p>x:Type的值应该是一个数据类型的名称，当我们想在XAML中表达某个数据类型时就需要使用x:Type标记扩展。比如某个类的一个属性，它的值要求是一种数据类型，当我们在XAML中为该属性赋值时就要用到x:Type。</p>
<p>例如，我们首先创建了一个MyButton类，派生自Button：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">MyButton</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Button</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name">Type</span> UserWindowType <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-override">override</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">OnClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-base">base</span><span class="token punctuation">.</span><span class="token function">OnClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//激发OnClick事件，测试发现注释后依然有效</span>
            <span class="token class-name">Window</span> win <span class="token operator">=</span> <span class="token punctuation">(</span>Window<span class="token punctuation">)</span>Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>UserWindowType<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//使用指定类型的默认构造函数来创建实例</span>
            win<span class="token punctuation">.</span><span class="token function">ShowDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>然后在项目中右键添加一个WPF窗口类，取名为MyWindow，随意添加几个控件：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window</span> <span class="token attr-name"><span class="token namespace">x:</span>Class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Net4._8WpfApp1.MyWindow<span class="token punctuation">"</span></span>
        <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml/presentation<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>d</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/expression/blend/2008<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>mc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.openxmlformats.org/markup-compatibility/2006<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>local</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:Net4._8WpfApp1<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">mc:</span>Ignorable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>d<span class="token punctuation">"</span></span>
        <span class="token attr-name">Title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MyWindow<span class="token punctuation">"</span></span> <span class="token attr-name">Height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>180<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span><span class="token punctuation">&gt;</span></span>OK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>最后将MyButton这个自定义按钮添加到主窗口的界面上，并把MyWindow作为一种数据类型赋值给MyButton的UserWindowType属性：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window</span> <span class="token attr-name"><span class="token namespace">x:</span>Class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Net4._8WpfApp1.MainWindow<span class="token punctuation">"</span></span>
        <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml/presentation<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>d</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/expression/blend/2008<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>mc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.openxmlformats.org/markup-compatibility/2006<span class="token punctuation">"</span></span>          
        <span class="token attr-name"><span class="token namespace">xmlns:</span>local</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:Net4._8WpfApp1<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">xmlns:</span>sys</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:System;assembly=mscorlib<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">mc:</span>Ignorable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>d<span class="token punctuation">"</span></span>
        <span class="token attr-name">Title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>NET4.8<span class="token punctuation">"</span></span> <span class="token attr-name">Height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>220<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>400<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>MyButton</span> <span class="token attr-name">Content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Show<span class="token punctuation">"</span></span> <span class="token attr-name">UserWindowType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{x:Type local:MyWindow}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>单击主窗口上的按钮，自定义窗体就会显示出来，我们还可以再写几个MyWindow2、MyWindow3，到时候只需要在XAML标记里更换UserWindowType的值即可。<br>
<img src="2023-02-12-15-49-52.png" alt=""></p>
<h3 id="xnull">x:Null </h3>
<p>在XAML里，用x:Null来表示空值。大多数时候我们不需要显式地为一个属性赋值为null，但如果一个属性具有默认值而我们又不需要该默认值，就要用x:Null显式设置了。</p>
<p>下面的例子设置了Style的TargetType，因此所有Button都会默认使用这个Style，除非显式指定其它Style：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Style</span> <span class="token attr-name">TargetType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{x:Type Button}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Setter</span> <span class="token attr-name">Property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Background<span class="token punctuation">"</span></span> <span class="token attr-name">Value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>LightGreen<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Setter</span> <span class="token attr-name">Property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Foreground<span class="token punctuation">"</span></span> <span class="token attr-name">Value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Red<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Setter</span> <span class="token attr-name">Property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>FontWeight<span class="token punctuation">"</span></span> <span class="token attr-name">Value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Bold<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Style</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">Style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{x:Null}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-12-16-01-27.png" alt=""></p>
<h3 id="xarray">x:Array </h3>
<p>x:Array的作用就是向使用者暴露一个类型已知的ArrayList实例，ArrayList内成员的类型由x:Array的Type指明。在WPF中把包含数据的对象称为数据源(Data Source)，如果想把一个x:Array的实例作为数据源提供给ListBox的话，XAML标记如下：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox.ItemsSource</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">x:</span>Array</span> <span class="token attr-name">Type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sys:String<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">sys:</span>String</span><span class="token punctuation">&gt;</span></span>hello<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">sys:</span>String</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">sys:</span>String</span><span class="token punctuation">&gt;</span></span>world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">sys:</span>String</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">x:</span>Array</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox.ItemsSource</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-12-16-12-54.png" alt=""></p>
<p>在解析x:Array标签时编译器会生成调用ArrayExtension的AddChild的方法将子元素逐个添加到ArrayExtension实例的Items属性里。</p>
<h3 id="xstatic">x:Static </h3>
<p>x:Static可在XAML中使用数据类型的static成员，属性或字段皆可访问。</p>
<p>下面在MainWindow中加入1个public static属性和1个public static字段：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-partial">partial</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Window</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name1 <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token class-name"><span class="token keyword keyword-string">string</span></span> Name2  <span class="token operator">=</span> <span class="token string">"world"</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-public">public</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>在XAML中使用x:Static来访问：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{x:Static local:MainWindow.Name1}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{x:Static local:MainWindow.Name2}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-12-16-25-29.png" alt=""></p>
<p>如果一个程序需要国际化支持，一般会把需要显示的字符串保存在一个资源类的static属性中，因此该程序对x:Static的使用十分频繁。</p>
<h2 id="xaml指令元素">XAML指令元素 </h2>
<p>XAML指令元素只有2个：</p>
<blockquote>
<p>x:Code<br>
x:XData</p>
</blockquote>
<p>x:Code可包含一些原本放在C#文件中的代码。</p>
<p>x:XData是一个专用标签。WPF中把包含数据的对象称为数据源，将数据源中数据提供给使用者的对象称为数据提供者(Data Provider)。WPF类库中有许多数据提供者，例如XmlDataProvider，专门用于提供XML化的数据。<br>
TODO：认为不重要，没看。</p>
<h1 id="控件与布局">控件与布局 </h1>
<h2 id="控件到底是什么">控件到底是什么 </h2>
<p>从现在开始要在心中树立起这样一个概念，即WPF中是数据驱动UI，数据是核心，是主动的；UI从属于数据并表达数据，是被动的。</p>
<p>WPF把能够展示数据、响应用户操作的UI元素称为控件(Control)，控件所展示的数据，我们称之为控件的“数据内容”，控件响应用户操作后执行的方法或事件，我们称之为控件的“行为”或“算法内容”。</p>
<p>控件继承层次如下：<br>
DispatcherObject<br>
DependencyObject<br>
Visual<br>
UIElement<br>
FrameworkElement<br>
Control<br>
ItemsControl<br>
HeaderedItemsControl</p>
<pre class="language-text">                    ContentControl
                        HeaderedContentControl
                        ButtonBase
                            Button

                    TextBoxBase
                        TextBox                        

                Panel
                    Grid

                TextBlock
                Image            
</pre>
<h2 id="wpf的内容模型">WPF的内容模型 </h2>
<p>因为允许嵌套控件，所以WPF的UI会形成一个树形结构。WPF控件一般由更基本的控件构成，如果不考虑控件内部的组成结构，只观察由控件组成的“树”，那么这棵树称为逻辑树(Logicl Tree)。如果连组成控件的更基本控件也一起考虑，那么这棵更繁茂树称为可视化树(Visual Tree)。</p>
<p>控件通过内容属性(Content Property)引用着作为其内容的对象。内容属性是个统称，具体到每种控件，内容属性都有自己确切的名字，例如Content、Child、Children、Items等。</p>
<h2 id="各类内容模型详解">各类内容模型详解 </h2>
<p>我们把符合某类内容模型的UI元素称为一个族，每个族用它们的共同基类来命名。注意，有些族省略，因为比较简单。</p>
<h3 id="contentcontrol族">ContentControl族 </h3>
<p>特点：</p>
<blockquote>
<p>均派生自ContentControl类<br>
都是控件<br>
内容属性的名称为Content<br>
只能由单一元素充当其内容</p>
</blockquote>
<h3 id="itemscontrol族">ItemsControl族 </h3>
<p>特点：</p>
<blockquote>
<p>均派生自ItemsControl类<br>
都是控件，用于显示列表化的数据<br>
内容属性为Items或ItemsSource<br>
每种ItemsControl都对应有自己的条目容器(Item Container)</p>
</blockquote>
<p>本族控件最有特色点的就是会自动使用条目容器对提交给它的内容进行包装，合法的ItemsControl的内容一定是个集合。当我们把这个集合作为内容提交给ItemsControl时，ItemsControl不会把这个集合直接拿来用，而是使用自己对应的条目容器把集合中的条目逐个包装，再把包装好的条目序列当作自己的内容。这样做的好处是允许程序员向ItemsControl提交各种数据类型的集合。如果要增删改或排序，那么直接操作数据即可，UI会自动将改变展现出来。这正体现了WPF数据驱动UI的特性。</p>
<p>首先，我们看看VisualTree的自动包装：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CheckBox</span><span class="token punctuation">&gt;</span></span>checkbox1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CheckBox</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CheckBox</span><span class="token punctuation">&gt;</span></span>checkbox2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CheckBox</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CheckBox</span><span class="token punctuation">&gt;</span></span>checkbox3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CheckBox</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span><span class="token punctuation">&gt;</span></span>button1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span><span class="token punctuation">&gt;</span></span>button2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span><span class="token punctuation">&gt;</span></span>button3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-21-10-09-15.png" alt=""></p>
<p>我们看看button3的父级容器是什么：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button3_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Button</span> btn <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span>sender<span class="token punctuation">;</span>
        <span class="token class-name">DependencyObject</span> level1 <span class="token operator">=</span> VisualTreeHelper<span class="token punctuation">.</span><span class="token function">GetParent</span><span class="token punctuation">(</span>btn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DependencyObject</span> level2 <span class="token operator">=</span> VisualTreeHelper<span class="token punctuation">.</span><span class="token function">GetParent</span><span class="token punctuation">(</span>level1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DependencyObject</span> level3 <span class="token operator">=</span> VisualTreeHelper<span class="token punctuation">.</span><span class="token function">GetParent</span><span class="token punctuation">(</span>level2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"    </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">level1<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">\n    </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">level2<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">\n    </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">level3<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-02-21-10-28-42.png" alt=""></p>
<p>可以发现button3的父级容器是ListBoxItem。前面我们知道WPF的UI是树形结构，VisualTreeHelper就是帮助我们在可视化树上进行导航的辅助类。我们沿着被单击的Button一层层往上找，到第三层发现是一个ListBoxItem。无论把什么样的数据集合交给ListBox，它都会以这种方式进行自动包装。</p>
<p>假设程序中有Employee类：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lstBox<span class="token punctuation">"</span></span> <span class="token attr-name">SelectionChanged</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lstBox_SelectionChanged<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">Employee</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-int">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token function">Employee</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-int">int</span></span> id<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Id <span class="token operator">=</span> id<span class="token punctuation">;</span>
            Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-public">public</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List<span class="token punctuation">&lt;</span>Employee<span class="token punctuation">&gt;</span></span> employees <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Employee<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Employee</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Employee</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Employee</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Helen"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Employee</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"Smith"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        lstBox<span class="token punctuation">.</span>ItemsSource <span class="token operator">=</span> employees<span class="token punctuation">;</span>
        lstBox<span class="token punctuation">.</span>DisplayMemberPath <span class="token operator">=</span> <span class="token string">"Name"</span><span class="token punctuation">;</span>  <span class="token comment">//告诉ListBox显示每条数据的哪个属性，换句话说，调用该属性的ToString方法，将得到的字符串放入TextBlock中，再把TextBlock包装进一个ListBoxItem中</span>

        lstBox<span class="token punctuation">.</span>SelectedValuePath <span class="token operator">=</span> <span class="token string">"Id"</span><span class="token punctuation">;</span>    <span class="token comment">//ListBox的SelectedValuePath属性会与其SelectedValue属性配合使用。当我们调用SelectedValue属性时，ListBox先找到选中Item对应的数据对象，然后把SelectedValuePath的值作为数据对象的属性名称，并把这个属性的值取出来</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">lstBox_SelectionChanged</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">SelectionChangedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>lstBox<span class="token punctuation">.</span>SelectedValue<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-02-21-11-10-14.png" alt=""></p>
<p>DisplayMemberPath和SelectedValuePath是两个相当简化的属性。DisplayMemberPath只能显示简单的字符串，可以用功能更加强大的DataTemplate。SelectedValuePath也只能返回单一的值，不妨直接使用SelectedItem和SelectedItems属性，它们返回的是数据集合中的对象。</p>
<h3 id="panel族">Panel族 </h3>
<p>特点：</p>
<blockquote>
<p>派生自Panel抽象类<br>
主要功能是控制UI布局<br>
内容属性为Children<br>
内容可以是多个元素，Panel元素将控制它们的布局</p>
</blockquote>
<h1 id="深入浅出话binding">深入浅出话Binding </h1>
<h2 id="binding基础">Binding基础 </h2>
<p>如果把Binding比作数据的桥梁，那么它的两端分别是Binding的源(Source)和目标(Target)。源是数据从哪里来，目标是数据往哪里去。一般情况下，Binding源是逻辑层对象，Binding目标是UI层控件对象。这样数据就会源源不断通过Binding送达UI层、被UI层展现，也就完成了数据驱动UI的过程。我们可以想象Binding这座桥梁上铺设了高速公路，不但可以控制在源与目标之间是双向通行还是某个方向单向通行，还可以控制对数据放行的时机，甚至在桥上架设关卡用来转换数据类型或校验数据。</p>
<p>下面创建一个简单的数据源并通过Binding把它连接到UI元素上。<br>
首先创建一个名为Student的类，该类的实例将作为数据源使用。</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-private">private</span> <span class="token class-name"><span class="token keyword keyword-string">string</span></span> _name<span class="token punctuation">;</span>

        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name <span class="token punctuation">{</span>
            <span class="token keyword keyword-get">get</span> <span class="token punctuation">{</span> <span class="token keyword keyword-return">return</span> _name<span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token keyword keyword-set">set</span> <span class="token punctuation">{</span> _name <span class="token operator">=</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-public">public</span> <span class="token function">Student</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>数据源是一个对象，对象一般通过属性向外界暴露数据，那么哪个属性是我们想通过Binding送达UI元素的呢？换句话说，UI关心哪个属性值的变化，这个属性就称为Binding的路径(Path)。但只有路径还不行，值变化后属性要有能力通知Binding，因此我们要让作为数据源的类实现INotifyPropertyChanged接口。当为Binding设置数据源后，Binding就会自动侦听其PropertyChanged事件。</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">Student</span> <span class="token punctuation">:</span><span class="token type-list"><span class="token class-name">INotifyPropertyChanged</span></span><span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-event">event</span> <span class="token class-name">PropertyChangedEventHandler</span> PropertyChanged<span class="token punctuation">;</span>

        <span class="token keyword keyword-private">private</span> <span class="token class-name"><span class="token keyword keyword-string">string</span></span> _name<span class="token punctuation">;</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name <span class="token punctuation">{</span>
            <span class="token keyword keyword-get">get</span> <span class="token punctuation">{</span> <span class="token keyword keyword-return">return</span> _name<span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token keyword keyword-set">set</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>_name <span class="token operator">!=</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    _name <span class="token operator">=</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">;</span>
                    PropertyChanged<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">PropertyChangedEventArgs</span><span class="token punctuation">(</span><span class="token string">"Name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//OnPropertyChanged();//或者直接调用这一句</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//public void OnPropertyChanged([CallerMemberName] string propertyName = null) {</span>
        <span class="token comment">//    PropertyChanged.Invoke(this, new PropertyChangedEventArgs(propertyName));</span>
        <span class="token comment">//}</span>

        <span class="token keyword keyword-public">public</span> <span class="token function">Student</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>经过这样一升级，当Name属性的值发生变化时，就会激发PropertyChanged事件，Binding接收到这个事件后发现是名为Name的属性值发生了变化，于是通知Binding目标端的UI元素显示新值。</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>textBox<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">Click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Button_Click<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Change Name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>使用Binding把数据源和UI元素连接起来：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-partial">partial</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Window</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-private">private</span> <span class="token class-name">Student</span> _stu<span class="token punctuation">;</span>

        <span class="token keyword keyword-public">public</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            _stu <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//这个实例就是数据源</span>
            <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"Name"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Source <span class="token operator">=</span> _stu
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            BindingOperations<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>textBox<span class="token punctuation">,</span>TextBox<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//textBox.SetBinding(TextBox.TextProperty, binding);或者这样写</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _stu<span class="token punctuation">.</span>Name <span class="token operator">+=</span> <span class="token string">"Name"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-02-22-11-23-11.png" alt=""></p>
<p>通过这个例子，我们已经在头脑中建立了以下模型：<br>
<img src="2023-02-22-11-33-19.png" alt=""></p>
<h2 id="binding的源与路径">Binding的源与路径 </h2>
<p>除了使用上述公开了属性的对象作为数据源外，我们还有更多选择，例如：</p>
<ul>
<li>控件把自己或自己的元素作为源</li>
<li>用一个控件作为另一个控件的数据源</li>
<li>把集合作为ItemsControl的数据源</li>
<li>使用XML作为TreeView或Menu的数据源</li>
<li>把多个控件关联到一个“数据制高点”上，甚至干脆不给Binding指定源，让它自己去找</li>
</ul>
<h3 id="把控件作为binding源与binding标记扩展">把控件作为Binding源与Binding标记扩展 </h3>
<p>大多数情况下Binding的源是逻辑层对象，但有时候为了让UI元素产生一些联动效果，也会使用Binding在控件间建立关联。下面把TextBox的Text属性关联在Slider的Value属性上。</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Slider</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Slider</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Value, ElementName=slider}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- Binding类的构造器接受一个Path作为参数，所以可以这样写： --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Value, ElementName=slider}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-22-12-14-58.png" alt=""></p>
<p>在C#代码中可以访问XAML代码中声明的变量，但XAML中无法访问C#代码中声明的变量。因此想要在XAML中建立UI元素与逻辑层对象的Binding，需要把逻辑层对象声明为XAML中的资源(Resource)，我们会在资源一章进行讲解。</p>
<p>也可以用代码实现绑定：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"Value"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> ElementName <span class="token operator">=</span> <span class="token string">"slider"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//Binding binding = new Binding("Value") { Source = slider };//在代码中一般直接把对象赋值给Source属性，而不会使用ElementName</span>

    textBox<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBox<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="控制binding的方向及数据更新">控制Binding的方向及数据更新 </h3>
<p>默认情况下，数据既能通过Binding送达目标，也能够从目标返回源(收集用户对数据的修改)。有时候数据只需要展示给用户而不允许修改，这时可把Binding的模式更改为从源向目标的单向沟通。Binding还支持从目标向源的单项沟通、只在Binding关系确立时读取一次数据，这需要我们根据实际情况去选择。</p>
<p>控制binding数据流向的属性是Mode，它的类型是BindingMode枚举，BindingMode枚举取值如下：</p>
<ul>
<li>TwoWay</li>
<li>OneWay</li>
<li>OneTime</li>
<li>OneWayToSource</li>
<li>Default：Binding的模式根据实际情况确定，若是可编辑的(例如TextBox的Text属性)，Default就采用双向模式，若是只读的(TextBlock的Text属性)则采用单向模式。</li>
</ul>
<p>在前面的例子中，我们拖动Slider的手柄时，TextBox中就会显示Slider的当前值。如果我们在TextBox中输入一个恰当的值并使焦点离开TextBox，则Slider的手柄会跳到相应的值那里。为何在TextBox失去焦点后，Slider的值才会改变呢？这就引出了Binding的另一个属性，即UpdateSourceTrigger，它的类型是一个枚举，取值如下：</p>
<ul>
<li>Default</li>
<li>PropertyChanged</li>
<li>LostFocus</li>
<li>Explicit</li>
</ul>
<p>将UpdateSourceTrigger设为PropertyChanged，即可立即更新。</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Slider</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Slider</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Value, ElementName=slider, UpdateSourceTrigger=PropertyChanged}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>顺便一提，Binding还有NotifyOnSourceUpdated、NotifyOnTargetUpdated两个bool属性，如果设置为true，则可以监听SourceUpdated、TargetUpdated事件，用来找出哪些数据或控件被更新了。</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Value, ElementName=slider, UpdateSourceTrigger=PropertyChanged, NotifyOnSourceUpdated=True, NotifyOnTargetUpdated=True}<span class="token punctuation">"</span></span> 
            <span class="token attr-name">SourceUpdated</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TextBox_SourceUpdated<span class="token punctuation">"</span></span> <span class="token attr-name">TargetUpdated</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TextBox_TargetUpdated<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><h3 id="binding的路径path">Binding的路径(Path) </h3>
<p>作为Binding源的对象可能有很多属性，那么Binding到底需要关注哪个属性的值呢？这就要由Binding的Path属性来指定了。先前的例子中，我们把Slider作为源，其Value属性作为路径。</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>textBox<span class="token punctuation">"</span></span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding ElementName=slider,Path=Value}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>与之等价的C#代码是：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Path <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">PropertyPath</span><span class="token punctuation">(</span><span class="token string">"Value"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Source <span class="token operator">=</span> slider
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    textBox<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBox<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Binding还支持多级路径，通俗地讲就是一路“点”下去，例如让一个TextBox显示另一个TextBox的文本长度：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding ElementName=textBox,Path=Text.Length,Mode=OneWay}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>等效的C#代码：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"Text.Length"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Source <span class="token operator">=</span> textBox<span class="token punctuation">,</span>
        Mode <span class="token operator">=</span> BindingMode<span class="token punctuation">.</span>OneWay<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    textBoxSecond<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBox<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>让一个TextBox显示另一个TextBox文本中下标为4的字符：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>textBoxSecond<span class="token punctuation">"</span></span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding ElementName=textBox,Path=Text.[4],Mode=OneWay}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!-- 或者把.省略，直接写为Text[4] --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>textBoxSecond<span class="token punctuation">"</span></span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding ElementName=textBox,Path=Text[4],Mode=OneWay}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>等效的C#代码：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"Text[4]"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Source <span class="token operator">=</span> textBox<span class="token punctuation">,</span>
        Mode <span class="token operator">=</span> BindingMode<span class="token punctuation">.</span>OneWay<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    textBoxSecond<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBox<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="没有明确书写path的binding">没有明确书写Path的Binding </h3>
<p>有时候我们会在代码中看到Path是一个“.”或者根本没有，这是一种特殊的情况，即Binding源本身就是数据且不需要Path来指明，例如源是一个string、int等。这时我们只需将Path值设为“.”就可以了。XAML中“.”可以省略不写，但C#代码中必须写。</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token comment">&lt;!-- 这两种写法一样 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=.,Source={StaticResource myString}}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding .,Source={StaticResource myString}}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 省略了Path，但这样Mode取值就有要求了 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Source={StaticResource myString},Mode=OneWay}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>等效的C#代码：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name"><span class="token keyword keyword-string">string</span></span> myString <span class="token operator">=</span> <span class="token string">"HELLO WORLD"</span><span class="token punctuation">;</span>
    <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Source<span class="token operator">=</span> myString
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    textBox<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBox<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="为binding指定源source的几种方法">为Binding指定源(Source)的几种方法 </h3>
<p>在上一小节我们通过学习Binding的Path知道了如何在一个对象上寻找数据，这一小节我们来学习如何为Binding指定Source。</p>
<p>Binding的源是数据来源，只要一个对象通过属性把数据暴露出来，就能作为Binding源。包含数据的对象比比皆是，但必须为Binding的Source指定合适的对象，Binding才能正常工作。常见的办法有：</p>
<ul>
<li>
<p>把普通CLR类型单个对象指定为Source，包括用户自定义类型。如果类型实现了INotifyPropertyChanged接口，则可以在属性的set语句里激发PropertyChanged事件来通知Binding数据已被更新。</p>
</li>
<li>
<p>把普通CLR集合类型对象指定为Source，包括数组、List<t>、ObservableCollection<t>等。实际工作中我们经常把控件的ItemsSource属性使用Binding关联到一个集合对象上。</t></t></p>
</li>
<li>
<p>把ADO.NET数据对象指定为Source，包括DataTable和DataView。</p>
</li>
<li>
<p>使用XmlDataProvider把XML数据指定为Source。</p>
</li>
<li>
<p>把依赖对象(Dependency Object)指定为Source。依赖对象不仅可以作为Binding的目标，也可以作为Binding的源，这样就有可能形成Binding链。依赖对象中的依赖属性可作为Binding的Path。</p>
</li>
<li>
<p>把容器的DataContext指定为Source(WPF Data Binding的默认行为)。有时候我们明确知道将从哪个属性获取数据，但具体把哪个对象作为Binding源还不清楚，这时我们可以建立一个Binding，只设置其Path属性，让这个Binding自己去找Source。Binding会一层层往外找DataContext，直到找到带有Path指定属性的对象为止。</p>
</li>
<li>
<p>通过ElementName指定Source。在C#代码中可以直接给Binding的Source赋一个对象，但XAML中无法访问对象，只能用对象的Name属性来找到对象。</p>
</li>
<li>
<p>通过Binding的RelativeSource属性相对地指定Source。当控件需要关注自己的、自己容器的或自己内部元素的某个值时，就要用这种方法。</p>
</li>
<li>
<p>把ObjectDataProvider对象指定为Source。当数据源的数据不是通过属性，而是通过方法暴露给外界时，可以使用这两种对象来包装数据源，再把它们指定为Source。</p>
</li>
<li>
<p>把使用LINQ检索得到的数据对象作为Binding源。</p>
</li>
</ul>
<p>下面一一分析这几种情况</p>
<h3 id="没有source的binding使用datacontext作为binding源">没有Source的Binding，使用DataContext作为Binding源 </h3>
<p>FrameworkElement类中定义了DataContext属性，FrameworkElement类是Control类的父类，这意味着所有WPF控件都具备这个属性。当一个Binding只知道自己的Path而不知道Source时，就会沿着UI元素树一路向树根找过去，每路过一个节点就要看看这个节点的DataContext是否具有Path所指定的属性。如果有，就把这个DataContext对象作为自己的Source，如果到了根部还没有找到，那这个Binding就没有Source，因而不会得到数据。</p>
<p>先创建一个名为Student的类：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-int">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel.DataContext</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>Student</span> <span class="token attr-name">Id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Jack<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">local:</span>Student</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel.DataContext</span><span class="token punctuation">&gt;</span></span>
        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Id}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Name}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>

                <span class="token comment">&lt;!-- Binding的构造器接受Path参数，故可以直接这样写 --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Id}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Name}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-23-16-42-54.png" alt=""></p>
<p>前面我们学习了当Binding的Source本身就是数据，不需要通过属性来暴露数据时，Binding的Path可以设置为“.”或省略不写，现在有了DataContext，Soucre也能省略不写，于是我们看到一个既没有Path又没有Source的Binding：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel.DataContext</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">sys:</span>String</span><span class="token punctuation">&gt;</span></span>Hello DataContext<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">sys:</span>String</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel.DataContext</span><span class="token punctuation">&gt;</span></span>
        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Mode=OneWay}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-23-16-50-42.png" alt=""></p>
<p>Binding是怎样自动沿着UI元素树向上找DataContext对象作为Source的呢？其实“沿着UI元素树向上找”只是WPF给我们的错觉，Binding没有这么智能。之所以有这种效果是因为DataContext是一个依赖项属性，依赖项属性有一个很重要的特点，那就是当你没有为控件的某个依赖项属性显式赋值时，控件会把自己容器的属性值“借过来”当作自己的属性值，实际上是属性值沿着UI元素树向下传递了。</p>
<p>最外层的DataContext会一直传递到Button：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name">DataContext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hello<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">Click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Button_Click<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>OK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Button</span> button<span class="token operator">=</span><span class="token punctuation">(</span>Button<span class="token punctuation">)</span>sender<span class="token punctuation">;</span>
        MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">button<span class="token punctuation">.</span>DataContext</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-02-23-16-59-01.png" alt=""></p>
<p>在实际工作中DataContext的用法是非常灵活的，例如：</p>
<ul>
<li>
<p>当多个控件都使用Binding关注同一个对象时，可以使用DataContext。</p>
</li>
<li>
<p>当作为Source的对象不能被直接访问时，可使用DataContext。例如窗体A把自己的某个私有控件或控件值放到A的DataContext(这个属性是public)上，这样别的元素都能看见，窗体B就能将该DataContext作为自己的Binding源。另外，DataContext本身也是一个依赖项属性，我们可以使用Binding把它关联到一个数据源上。</p>
</li>
</ul>
<h3 id="使用集合对象作为列表控件的itemssource">使用集合对象作为列表控件的ItemsSource </h3>
<p>有了DataContext的基础知识，我们再来看看把集合类型对象作为Binding源的情况。</p>
<p>WPF中的列表控件继承自ItemsControl类，自然也就继承了ItemsSource这个属性。ItemsSource可以接收一个IEnumerable接口派生类的实例，所有可迭代遍历的集合都实现了这个接口。每个ItemsControl的派生类都有自己对应的条目容器，例如ListBox是ListBoxItem，ComboBox是BomboBoxItem。ItemsSource里存放的是一条条数据，想要把数据显示出来需要为它们穿上“外衣”，条目容器就起到数据外衣的作用。怎样让每件数据外衣与对应的条目容器关联起来呢？当然是靠Binding。只要我们设置了ItemsControl对象的ItemsSource属性，ItemsControl对象就会自动迭代其中的数据元素、为每个数据元素准备一个条目容器，并使用Binding在条目容器与数据元素之间建立关联。<br>
下例在选中ListBox中的一项时可显示对应Student对应的Id：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lstBox<span class="token punctuation">"</span></span> <span class="token attr-name">DisplayMemberPath</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Name<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBlock<span class="token punctuation">"</span></span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding ElementName=lstBox,Path=SelectedItem.Id}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBlock</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        lstBox<span class="token punctuation">.</span>ItemsSource <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Student<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-class">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token function">Student</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-int">int</span></span> id<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Id <span class="token operator">=</span> id<span class="token punctuation">;</span>
            Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-int">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-02-25-10-17-48.png" alt=""></p>
<p>也可以用C#代码设置绑定：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    lstBox<span class="token punctuation">.</span>ItemsSource <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Student<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    lstBox<span class="token punctuation">.</span>DisplayMemberPath <span class="token operator">=</span> <span class="token string">"Name"</span><span class="token punctuation">;</span>

    <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"SelectedItem.Id"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Source <span class="token operator">=</span> lstBox<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword keyword-var">var</span></span> binding2 <span class="token operator">=</span> txtBlock<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBlock<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>也可以设置TextBlock容器的DataContext属性，写法如下：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel<span class="token punctuation">"</span></span> <span class="token attr-name">DataContext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding ElementName=lstBox,Path=SelectedItem}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lstBox<span class="token punctuation">"</span></span> <span class="token attr-name">DisplayMemberPath</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Name<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBlock<span class="token punctuation">"</span></span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Id}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBlock</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    lstBox<span class="token punctuation">.</span>ItemsSource <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Student<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>一般用<code>ObservableCollection&lt;T&gt;</code>作为列表控件的ItemsSource，因为它实现了INotifyCollectionChanged和INotifyPropertyChanged接口，能把集合的变化立刻通知给显示它的控件，改变会立刻显示出来。</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name">ObservableCollection<span class="token punctuation">&lt;</span>Student<span class="token punctuation">&gt;</span></span> students <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">ObservableCollection<span class="token punctuation">&lt;</span>Student<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    lstBox<span class="token punctuation">.</span>ItemsSource <span class="token operator">=</span> students<span class="token punctuation">;</span>
</code></pre><p>注意DisplayMemberPath属性，它以“Path”结尾，说明它是一个路径。当DisplayMemberPath被赋值后，ListBox在获得ItemsSource的时候就会创建等量的ListBoxItem并以DisplayMemberPath的属性值为Path创建Binding，Binding的目标是ListBoxItem的内容控件(实际上是一个TextBlock)。</p>
<p>如果在ItemsControl类的代码里刨根问底，会发现这个创建Binding的过程是在DisplayMemberTemplateSelector类的SelectTemplate方法中完成的，大致如下：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-override">override</span> <span class="token return-type class-name">DataTemplate</span> <span class="token function">SelectTemplate</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> item<span class="token punctuation">,</span> <span class="token class-name">DependencyObject</span> container<span class="token punctuation">)</span> <span class="token punctuation">{</span>            
        <span class="token comment">//...省略部分代码    </span>

        <span class="token class-name">FrameworkElementFactory</span> frameworkElementFactory2 <span class="token operator">=</span> ContentPresenter<span class="token punctuation">.</span><span class="token function">CreateTextBlockFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Binding</span> binding2 <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        binding2<span class="token punctuation">.</span>Path <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">PropertyPath</span><span class="token punctuation">(</span>_displayMemberPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        binding2<span class="token punctuation">.</span>StringFormat <span class="token operator">=</span> _stringFormat<span class="token punctuation">;</span>
        frameworkElementFactory2<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBlock<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//...省略部分代码</span>
    <span class="token punctuation">}</span>
</code></pre><p>注意到该方法的返回值是DataTemplate，数据的“外衣”就是由DataTemplate穿上的。当我们没有为ItemsControl显式指定DataTemplate时，SelectTemplate就会为我们创建一个默认的DataTemplate，就好像给数据穿上最简单的衣服一样。代码中只对新创建的Binding设置了Path，但未设置Source，因此这个Binding要向上层层寻找包含_displayMemberPath的DataContext。</p>
<p>我们可以显式地为数据设置DataTemplate，先把XAML中的DisplayMemberPath一句删除。ListBox的ItemTempalte属性的类型是DataTemplate，下面的代码就是为Student实例量身定做的衣服：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lstBox<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox.ItemTemplate</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataTemplate</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name">Orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Horizontal<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Name}<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>40<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBlock</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Id}<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>40<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBlock</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DataTemplate</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox.ItemTemplate</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name">ObservableCollection<span class="token punctuation">&lt;</span>Student<span class="token punctuation">&gt;</span></span> students <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">ObservableCollection<span class="token punctuation">&lt;</span>Student<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"Helen"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    lstBox<span class="token punctuation">.</span>ItemsSource <span class="token operator">=</span> students<span class="token punctuation">;</span>
</code></pre><p><img src="2023-02-25-11-30-18.png" alt=""></p>
<h3 id="使用adonet对象作为binding源">使用ADO.NET对象作为Binding源 </h3>
<p>TODO：未看</p>
<h3 id="使用xml数据作为binding源">使用XML数据作为Binding源 </h3>
<p>TODO：未看</p>
<h3 id="使用linq检索结果作为binding源">使用LINQ检索结果作为Binding源 </h3>
<p>TODO：未看</p>
<h3 id="使用objectdataprovider对象作为binding的source">使用ObjectDataProvider对象作为Binding的Source </h3>
<p>TODO：未看</p>
<h3 id="使用binding的relativesource">使用Binding的RelativeSource </h3>
<p>当一个Binding有明确数据来源时我们可以通过使用为Source或ElementName赋值的方式让Binding与之关联。有时候我们不能确定Source对象叫什么名字，但知道它与Binding目标在UI布局上有关联，比如控件关联自己的某个数据、关联自己某级容器的数据。此时我们可以用Binding的RelativeSource属性控制它搜索相对数据源的方式。</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>grid1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>grid2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox<span class="token punctuation">"</span></span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding RelativeSource ={RelativeSource Mode=FindAncestor, AncestorType={x:Type Grid}, AncestorLevel=1}, Path=Name}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-25-11-59-44.png" alt=""></p>
<p>AncestorLevel指的是以Binding目标控件为起点的层级偏移量，grid2偏移为1，stackPanel2偏移为2，grid1偏移为3，stackPanel1偏移为4。AncestorType指示要找哪个类型的对象作为自己的源，不是该类型的就会跳过。AncestorLevel参考AncestorType为基础生效，比如这里设置了AncestorType为Grid，那么grid2的AncestorLevel为1，grid1的AncestorLevel为2。这段代码告诉Binding向外寻找第1个Grid类型的对象作为自己的源。</p>
<p>也可以用C#代码表示：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name">RelativeSource</span> relativeSource <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">RelativeSource</span><span class="token punctuation">(</span>RelativeSourceMode<span class="token punctuation">.</span>FindAncestor<span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Grid</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"Name"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RelativeSource <span class="token operator">=</span> relativeSource
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    txtBox<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBox<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>如果讲AncestorType设为object，AncestorLevel设为2，那么找到的Binding源是stackPanel2：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>grid1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>grid2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox<span class="token punctuation">"</span></span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding RelativeSource ={RelativeSource Mode=FindAncestor, AncestorType={x:Type sys:Object}, AncestorLevel=2}, Path=Name}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-25-12-19-04.png" alt=""></p>
<p>如果TextBox需要关联自身的Name属性，则XAML代码如下：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox<span class="token punctuation">"</span></span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding RelativeSource ={RelativeSource Mode=Self}, Path=Name}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-25-12-22-00.png" alt=""></p>
<h2 id="binding对数据的转换与校验">Binding对数据的转换与校验 </h2>
<p>前面我们已经知道，Binding的作用就是架在Source与Target之间的桥梁，Binding这座桥上也可以设置关卡对数据的有效性进行校验，这需要用到它的ValidationRules属性。不仅如此，当Binding的两端要求使用不同数据类型时，我们还可以为数据设置转换器，这需要用到它的Converter属性。</p>
<h3 id="binding的数据校验">Binding的数据校验 </h3>
<p>Binding的ValidationRules属性是的类型是<code>Collection&lt;ValidationRule&gt;</code>，从名称和数据类型很容易知道可以为Binding设置多个数据校验条件，每个条件是一个ValidationRule对象。ValidationRule是个抽象类，因此在使用我们需要创建其派生类。</p>
<p>下面的Binding以Slider为源、TextBox为目标，我们校验TextBox中输入的值是否在0~100之间：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Slider</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span> <span class="token attr-name">Minimum</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">Maximum</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Slider</span><span class="token punctuation">&gt;</span></span>        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox.Text</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Binding</span> <span class="token attr-name">ElementName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Value<span class="token punctuation">"</span></span> <span class="token attr-name">UpdateSourceTrigger</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PropertyChanged<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Binding.ValidationRules</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>RangeValidationRule</span><span class="token punctuation">/&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Binding.ValidationRules</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Binding</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox.Text</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>为了进行校验，需要准备一个ValidationRule的派生类：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">RangeValidationRule</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ValidationRule</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-override">override</span> <span class="token return-type class-name">ValidationResult</span> <span class="token function">Validate</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">,</span> <span class="token class-name">CultureInfo</span> cultureInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token keyword keyword-double">double</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword keyword-string">string</span><span class="token punctuation">)</span><span class="token keyword keyword-value">value</span><span class="token punctuation">,</span> <span class="token keyword keyword-out">out</span> <span class="token class-name"><span class="token keyword keyword-double">double</span></span> d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>d <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> d <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">ValidationResult</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">ValidationResult</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"The range is error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>也可以自己通过C#代码设置绑定：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"Value"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Source <span class="token operator">=</span> slider<span class="token punctuation">,</span>
        UpdateSourceTrigger <span class="token operator">=</span> UpdateSourceTrigger<span class="token punctuation">.</span>PropertyChanged
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    binding<span class="token punctuation">.</span>ValidationRules<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">RangeValidationRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    txtBox<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBox<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><img src="2023-02-27-11-42-16.png" alt=""></p>
<p>如图所示，如果在TextBox中输入错误值，则会显示红色轮廓，表示值是错误的，不能把它传递给Source。</p>
<p>Binding进行校验时的默认行为是认为来自Source的数据总是正确的，只有来自Target的数据才可能有问题。也就是说，Binding的Source更新Target时不会进行校验。如果想对Source也进行验证，需要将校验条件的ValidatesOnTargetUpdated属性设为true：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox.Text</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Binding</span> <span class="token attr-name">ElementName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Value<span class="token punctuation">"</span></span> <span class="token attr-name">UpdateSourceTrigger</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PropertyChanged<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Binding.ValidationRules</span><span class="token punctuation">&gt;</span></span>
                    <span class="token comment">&lt;!-- 这里设置了ValidatesOnTargetUpdated属性 --&gt;</span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>RangeValidationRule</span> <span class="token attr-name">ValidatesOnTargetUpdated</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>True<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Binding.ValidationRules</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Binding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox.Text</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>也可使用等价的C#代码：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"Value"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Source <span class="token operator">=</span> slider<span class="token punctuation">,</span>
        UpdateSourceTrigger <span class="token operator">=</span> UpdateSourceTrigger<span class="token punctuation">.</span>PropertyChanged<span class="token punctuation">,</span>        
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword keyword-var">var</span></span> rule <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">RangeValidationRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> ValidatesOnTargetUpdated <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//指示对Source也进行校验</span>
    binding<span class="token punctuation">.</span>ValidationRules<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    txtBox<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBox<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><img src="2023-02-27-12-03-01.png" alt=""></p>
<p>设置后当滑块超出范围时，也会显示红色轮廓指示错误。</p>
<p>校验错误时，RangeValidationRule返回的结果中带有字符串"The range is error!"，如何将其显示出来呢？需要把Binding对象的NotifyOnValidationError设为true，并设置Validation.Error事件。Error事件是使用冒泡策略的路由事件，因此可通过在父容器中关联事件处理程序来为多个控件处理Error事件：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Slider</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span> <span class="token attr-name">Minimum</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">Maximum</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Slider</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox<span class="token punctuation">"</span></span> <span class="token attr-name">Validation.Error</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox_Error<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox.Text</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Binding</span> <span class="token attr-name">ElementName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider<span class="token punctuation">"</span></span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Value<span class="token punctuation">"</span></span> <span class="token attr-name">UpdateSourceTrigger</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PropertyChanged<span class="token punctuation">"</span></span> <span class="token attr-name">NotifyOnValidationError</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>True<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Binding.ValidationRules</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>RangeValidationRule</span> <span class="token attr-name">ValidatesOnTargetUpdated</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>True<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Binding.ValidationRules</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Binding</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox.Text</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">txtBox_Error</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">ValidationErrorEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword keyword-var">var</span></span> errors <span class="token operator">=</span> Validation<span class="token punctuation">.</span><span class="token function">GetErrors</span><span class="token punctuation">(</span>txtBox<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>Action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-case">case</span> ValidationErrorEventAction<span class="token punctuation">.</span>Added<span class="token punctuation">:</span>
                slider<span class="token punctuation">.</span>ToolTip <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">errors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ErrorContent</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
                <span class="token comment">//MessageBox.Show($"{errors[0].ErrorContent}");</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>

            <span class="token keyword keyword-case">case</span> ValidationErrorEventAction<span class="token punctuation">.</span>Removed<span class="token punctuation">:</span>
                <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//发生新错误时，上一个错误可能被清除了(猜测)</span>
                    <span class="token comment">//MessageBox.Show("OK");</span>
                    slider<span class="token punctuation">.</span>ToolTip <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>

            <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-02-27-12-55-00.png" alt=""></p>
<h3 id="binding的数据转换">Binding的数据转换 </h3>
<p>前面的很多例子中我们都用Binding在Slider和TextBox之间建立关联，Slider的Value属性是double类型，TextBox的Text是string类型。Binding有一种机制称为数据转换(Data Convert)，当Source端的Path所关联的数据与Target端目标属性类型不一致时，我们可以添加数据转换器(Data Converter)。像double和string这种简单类型之间的转换，WPF类库自动替我们做了，但有些复杂情况需要我们自己处理，例如：</p>
<ul>
<li>
<p>Source里的数据是A、B、C这三个值，可能是char、string、自定义枚举，需要将这3个值映射到CheckBox的IsChecked属性(bool? 类型)上。</p>
</li>
<li>
<p>当TextBox中已经输入文字时，用于登录的Button才出现，这是string与Visibility枚举类型或bool类型之间的转换(Binding的Mode将是OneWay)。</p>
</li>
<li>
<p>Source里的数据可能是Male、Female(string或枚举)，UI上是用于显示头像的Image控件，这时需要把Source里的值转换成对应的头像图片URI(也是OneWay)。</p>
</li>
</ul>
<p>遇到这些情况时，我们需要手动编写Converter，需要实现IValueConverter接口：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-interface">interface</span> <span class="token class-name">IValueConverter</span> <span class="token punctuation">{</span>
        <span class="token comment">//数据从Binding的Source流向Target时，Convert方法被调用。</span>
        <span class="token return-type class-name"><span class="token keyword keyword-object">object</span></span> <span class="token function">Convert</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">,</span> <span class="token class-name">Type</span> targetType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> parameter<span class="token punctuation">,</span> <span class="token class-name">CultureInfo</span> culture<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//数据从Binding的Target流向Source时，ConvertBack方法被调用。</span>
        <span class="token return-type class-name"><span class="token keyword keyword-object">object</span></span> <span class="token function">ConvertBack</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">,</span> <span class="token class-name">Type</span> targetType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> parameter<span class="token punctuation">,</span> <span class="token class-name">CultureInfo</span> culture<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p>综合实例如下，用于在列表里显示一些状态：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-enum">enum</span> <span class="token class-name">Category</span> <span class="token punctuation">{</span>
        VS<span class="token punctuation">,</span>
        VSCode
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-enum">enum</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
        Good<span class="token punctuation">,</span>
        Bad<span class="token punctuation">,</span>
        Unknown<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-class">class</span> <span class="token class-name">Software</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name">Category</span> Category <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name">State</span> State <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword keyword-public">public</span> <span class="token function">Software</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name">Category</span> category<span class="token punctuation">,</span> <span class="token class-name">State</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            Category <span class="token operator">=</span> category<span class="token punctuation">;</span>
            State <span class="token operator">=</span> state<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-class">class</span> <span class="token class-name">CategoryToSourceConverter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IValueConverter</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-object">object</span></span> <span class="token function">Convert</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">,</span> <span class="token class-name">Type</span> targetType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> parameter<span class="token punctuation">,</span> <span class="token class-name">CultureInfo</span> culture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Category</span> category <span class="token operator">=</span> <span class="token punctuation">(</span>Category<span class="token punctuation">)</span><span class="token keyword keyword-value">value</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>category<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token keyword keyword-case">case</span> Category<span class="token punctuation">.</span>VS<span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> <span class="token string">@"/Images/vs.png"</span><span class="token punctuation">;</span>     <span class="token comment">//XAML编译器能把string解析为图片资源</span>
                <span class="token keyword keyword-case">case</span> Category<span class="token punctuation">.</span>VSCode<span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> <span class="token string">@"/Images/vscode.png"</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//不会被调用</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-object">object</span></span> <span class="token function">ConvertBack</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">,</span> <span class="token class-name">Type</span> targetType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> parameter<span class="token punctuation">,</span> <span class="token class-name">CultureInfo</span> culture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">NotImplementedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-class">class</span> <span class="token class-name">StateToNullableBoolConverter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IValueConverter</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-object">object</span></span> <span class="token function">Convert</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">,</span> <span class="token class-name">Type</span> targetType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> parameter<span class="token punctuation">,</span> <span class="token class-name">CultureInfo</span> culture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">State</span> state<span class="token operator">=</span><span class="token punctuation">(</span>State<span class="token punctuation">)</span><span class="token keyword keyword-value">value</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-case">case</span> State<span class="token punctuation">.</span>Good<span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-case">case</span> State<span class="token punctuation">.</span>Bad<span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword keyword-case">case</span> State<span class="token punctuation">.</span>Unknown<span class="token punctuation">:</span>                    
                <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-object">object</span></span> <span class="token function">ConvertBack</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">,</span> <span class="token class-name">Type</span> targetType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> parameter<span class="token punctuation">,</span> <span class="token class-name">CultureInfo</span> culture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword keyword-bool">bool</span><span class="token punctuation">?</span></span> b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword keyword-bool">bool</span><span class="token punctuation">?</span><span class="token punctuation">)</span><span class="token keyword keyword-value">value</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-case">case</span> <span class="token boolean">true</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> State<span class="token punctuation">.</span>Good<span class="token punctuation">;</span>
                <span class="token keyword keyword-case">case</span> <span class="token boolean">false</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> State<span class="token punctuation">.</span>Bad<span class="token punctuation">;</span>
                <span class="token keyword keyword-case">case</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> State<span class="token punctuation">.</span>Unknown<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-public">public</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        lstBox<span class="token punctuation">.</span>ItemsSource <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">ObservableCollection<span class="token punctuation">&lt;</span>Software<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Software</span><span class="token punctuation">(</span><span class="token string">"vs"</span><span class="token punctuation">,</span>Category<span class="token punctuation">.</span>VS<span class="token punctuation">,</span>State<span class="token punctuation">.</span>Good<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Software</span><span class="token punctuation">(</span><span class="token string">"vs"</span><span class="token punctuation">,</span>Category<span class="token punctuation">.</span>VS<span class="token punctuation">,</span>State<span class="token punctuation">.</span>Bad<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Software</span><span class="token punctuation">(</span><span class="token string">"vs"</span><span class="token punctuation">,</span>Category<span class="token punctuation">.</span>VS<span class="token punctuation">,</span>State<span class="token punctuation">.</span>Unknown<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Software</span><span class="token punctuation">(</span><span class="token string">"vscode"</span><span class="token punctuation">,</span>Category<span class="token punctuation">.</span>VSCode<span class="token punctuation">,</span>State<span class="token punctuation">.</span>Good<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Software</span><span class="token punctuation">(</span><span class="token string">"vscode"</span><span class="token punctuation">,</span>Category<span class="token punctuation">.</span>VSCode<span class="token punctuation">,</span>State<span class="token punctuation">.</span>Bad<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Software</span><span class="token punctuation">(</span><span class="token string">"vscode"</span><span class="token punctuation">,</span>Category<span class="token punctuation">.</span>VSCode<span class="token punctuation">,</span>State<span class="token punctuation">.</span>Unknown<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>CategoryToSourceConverter</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cts<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">local:</span>CategoryToSourceConverter</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>StateToNullableBoolConverter</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stnb<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">local:</span>StateToNullableBoolConverter</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lstBox<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox.ItemTemplate</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataTemplate</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name">Orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Horizontal<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Image</span> <span class="token attr-name">Source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Category, Converter={StaticResource cts}}<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Name}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBlock</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CheckBox</span> <span class="token attr-name">IsChecked</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=State, Converter={StaticResource stnb}}<span class="token punctuation">"</span></span> <span class="token attr-name">IsThreeState</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>True<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DataTemplate</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox.ItemTemplate</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox</span><span class="token punctuation">&gt;</span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><h2 id="multibinding">MultiBinding </h2>
<p>有时候UI显示的信息不止由一个数据源决定，这时候就需要使用MultiBinding。MultiBinding和Binding一样，都是BindingBase的派生类，凡是能够使用Binding的场合都能使用MultiBinding。MultiBinding有一个名为Bindings的属性：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name">Collection<span class="token punctuation">&lt;</span>BindingBase<span class="token punctuation">&gt;</span></span> Bindings <span class="token operator">=&gt;</span> _bindingCollection<span class="token punctuation">;</span>
</code></pre><p>通过这个属性，MultiBinding把一组Binding对象聚合起来，每个Binding对象都可以拥有自己的数据校验与转换机制，它们汇集起来的数据共同决定传往MultiBinding目标的数据。<br>
<img src="2023-02-27-17-27-32.png" alt=""></p>
<p>考虑这样一个需求，有一个新用户注册的UI，包含4个TextBox和1个Button，还有如下限制：</p>
<ul>
<li>前两个TextBox输入用户名，要求内容一致。</li>
<li>后两个TextBox输入密码，要求内容一致。</li>
<li>前两个条件都满足时，Button才可用。</li>
</ul>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>LogonMultiBindingConverter</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lmbc<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">local:</span>LogonMultiBindingConverter</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox4<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBox</span><span class="token punctuation">&gt;</span></span>        

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button.IsEnabled</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MultiBinding</span> <span class="token attr-name">Converter</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{StaticResource lmbc}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token comment">&lt;!-- 这里添加子级Binding的顺序是敏感的，它决定了Convert方法的数组参数的元素顺序 --&gt;</span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Binding</span> <span class="token attr-name">ElementName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox1<span class="token punctuation">"</span></span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Text<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Binding</span> <span class="token attr-name">ElementName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox2<span class="token punctuation">"</span></span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Text<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Binding</span> <span class="token attr-name">ElementName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox3<span class="token punctuation">"</span></span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Text<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Binding</span> <span class="token attr-name">ElementName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox4<span class="token punctuation">"</span></span> <span class="token attr-name">Path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Text<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MultiBinding</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button.IsEnabled</span><span class="token punctuation">&gt;</span></span>
            Submit
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">LogonMultiBindingConverter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IMultiValueConverter</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-object">object</span></span> <span class="token function">Convert</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> values<span class="token punctuation">,</span> <span class="token class-name">Type</span> targetType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> parameter<span class="token punctuation">,</span> <span class="token class-name">CultureInfo</span> culture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//values数组中元素的顺序就是添加子级Binding时的顺序</span>
            <span class="token class-name"><span class="token keyword keyword-var">var</span></span> items <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Cast</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword keyword-string">string</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token keyword keyword-string">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> items<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
                items<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> items<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword keyword-return">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//不会被调用</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-object">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token function">ConvertBack</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">,</span> <span class="token class-name">Type<span class="token punctuation">[</span><span class="token punctuation">]</span></span> targetTypes<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> parameter<span class="token punctuation">,</span> <span class="token class-name">CultureInfo</span> culture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-throw">throw</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">NotImplementedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>也可用代码实现绑定：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name">MultiBinding</span> multiBinding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">MultiBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Converter <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">LogonMultiBindingConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">TextBox<span class="token punctuation">[</span><span class="token punctuation">]</span></span> textBoxes <span class="token operator">=</span> <span class="token punctuation">{</span> txtBox1<span class="token punctuation">,</span> txtBox2<span class="token punctuation">,</span> txtBox3<span class="token punctuation">,</span> txtBox4 <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//顺序是敏感的</span>
    <span class="token keyword keyword-foreach">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-var">var</span></span> item <span class="token keyword keyword-in">in</span> textBoxes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"Text"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Source <span class="token operator">=</span> item <span class="token punctuation">}</span><span class="token punctuation">;</span>
        multiBinding<span class="token punctuation">.</span>Bindings<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    

    btn<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>Button<span class="token punctuation">.</span>IsEnabledProperty<span class="token punctuation">,</span> multiBinding<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>不满足条件时，按钮不可用：<br>
<img src="2023-02-27-18-06-26.png" alt=""></p>
<p>满足条件时，按钮可用：<br>
<img src="2023-02-27-18-07-02.png" alt=""></p>
<h1 id="深入浅出话属性">深入浅出话属性 </h1>
<p>前面的学习中，我们知道了Data Binding是WPF“数据驱动UI”理念的基础，上一章我们聚焦于Binding的数据源，研究了Binding的Source和Path，本章我们聚焦于目标端，研究什么样的对象才能作为Binding的Target，以及Binding将把数据送往何处。</p>
<h2 id="依赖属性dependency-property">依赖属性(Dependency Property) </h2>
<p>简而言之，依赖属性是一种可以自己没有值，并能通过使用Binding从数据源获得值(依赖在别人身上)的属性，因此可节省实例对内存的开销。拥有依赖属性的对象被称为“依赖对象”。</p>
<h3 id="依赖属性对内存的使用方式">依赖属性对内存的使用方式 </h3>
<p>WPF允许对象在需要用到数据时能获得默认值、借用其它对象的数据，或实时分配空间。这种对象称为依赖对象(Dependency Object)，而它这种实时获取数据的能力就依靠依赖属性实现。WPF开发中，必须使用依赖对象作为依赖属性的宿主，使二者结合起来，才能形成完整的Binding目标被数据所驱动。</p>
<p>WPF中，依赖属性的概念被DependencyProperty实现，依赖对象的概念被DependencyObject实现，DependencyObject有GetValue和SetValue方法，这2个方法都以DependencyProperty为参数：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">DependencyObject</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DispatcherObject</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-object">object</span></span> <span class="token function">GetValue</span><span class="token punctuation">(</span><span class="token class-name">DependencyProperty</span> dp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//...</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetValue</span><span class="token punctuation">(</span><span class="token class-name">DependencyProperty</span> dp<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
</code></pre><p>DependencyObject是相当底层的一个基类，WPF所有UI控件都是依赖对象，UI控件的绝大多数属性都已依赖化了。</p>
<h3 id="声明和使用依赖属性">声明和使用依赖属性 </h3>
<p>如前所述，DependencyProperty必须以DependencyObject为宿主，借助它的GetValue、SetValue方法进行读写操作。因此想使用自定义的DependencyProperty，宿主一定要是DependencyObject的派生类。DependencyProperty实例的声明很鲜明，即引用变量由<code>public static readonly</code>三个修饰符修饰，实例不使用new而是使用DependencyProperty.Register方法生成。使用DependencyProperty的最简代码如下：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">Student</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DependencyObject</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-readonly">readonly</span> <span class="token class-name">DependencyProperty</span> NameProperty <span class="token operator">=</span> 
        DependencyProperty<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">"Name"</span><span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword keyword-string">string</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Student</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p>下面分析DependencyProperty.Register方法中的3个参数：</p>
<ul>
<li>
<p>第1个参数：指明以哪个CRL属性作为这个依赖属性的包装器，或者说此依赖属性支持(back)的是哪个CLR属性。目前虽然没有为这个依赖项属性准备包装器，但将来会使用名为Name的CLR属性来包装它,所以这个参数被赋值为Name。</p>
</li>
<li>
<p>第2个参数：指明此依赖属性用来存储什么类型的值，学生姓名是string类型，所以这里填typeof(string)。</p>
</li>
<li>
<p>第3个参数：指明此依赖属性的宿主是什么类型，或者说DependencyProperty.Register将把这个依赖属性注册关联到哪个类型上。本例的意图是为Student类准备一个可依赖的名称属性，所以需要把NameProperty注册成与Student关联，因此这里填typeof(Student)。</p>
</li>
</ul>
<p>这里有3点需要注意：</p>
<ul>
<li>
<p>依赖属性的包装器(Wrapper)是一个CLR属性，因为初学者头脑中的“属性”概念就是CLR属性，所以常把包装器误认为是依赖属性。实际上依赖属性就是由public static readonly修饰的DependencyProperty实例，有没有包装器这个依赖属性都存在。</p>
</li>
<li>
<p>既然有没有包装器这个依赖属性都存在，那包装器有何作用？包装器是以“实例属性”的形式向外界暴露依赖属性，这样一个依赖属性才能成为数据源的一个Path。</p>
</li>
<li>
<p>第2个参数是包装器的数据类型，它的全称应该是“依赖属性的注册类型”，但一般情况下也会把这个类型称为“依赖属性的类型”，严格来说依赖属性类型永远都是DependencyProperty，只是工作中叫惯了。</p>
</li>
</ul>
<p>理解了依赖项属性声明变量和创建实例的过程，我们就可以尝试使用它了，用这个依赖项属性存储值并把值读出来：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox1<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>txtBox2<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">Click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Button_Click<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> stu <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stu<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>NameProperty<span class="token punctuation">,</span> txtBox1<span class="token punctuation">.</span>Text<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//把txtBox1.Text存进依赖属性</span>
        txtBox2<span class="token punctuation">.</span>Text <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword keyword-string">string</span><span class="token punctuation">)</span>stu<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>NameProperty<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//把依赖属性的值读取出来，再赋给txtBox2.Text</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-02-28-11-05-47.png" alt=""></p>
<p>上例展现了依赖属性作为“属性”的功能，下面展示它的“依赖”性。一般情况下数据源是逻辑层对象而目标是UI层控件，这里我们倒过来让txtBox1作为数据源、让Student实例作为数据目标，即Student实例依赖在txtBox1上。这仅仅是展示依赖属性的“依赖”功能，现实中几乎不会这么做。</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-partial">partial</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Window</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> _stu <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-public">public</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            

            <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"Text"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Source <span class="token operator">=</span> txtBox1
            <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//数据源是txtBox1，通过其Text属性暴露数据</span>

            BindingOperations<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>_stu<span class="token punctuation">,</span> Student<span class="token punctuation">.</span>NameProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            txtBox2<span class="token punctuation">.</span>Text <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword keyword-string">string</span><span class="token punctuation">)</span>_stu<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>NameProperty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>        
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-02-28-11-27-00.png" alt=""></p>
<p>代码的进化还没有结束，txtBox2也可以依赖在txtBox1上，加一句代码即可：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    txtBox2<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBox<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>这里调用了txtBox2的SetBinding方法，感觉起来比BindingOperations.SetBinding的第三人称视角要自然。如果调用stu的SetBinding方法，会发现并没有这个方法，因为该方法在相当高层的FrameworkElement类中。这从侧面向我们传递了一个信息，即微软希望能够SetBinding(即作为数据目标)的对象是UI元素。</p>
<p>FrameworkElement类的SetBinding方法只是对BindingOperations.SetBinding做了封装而已：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">FrameworkElement</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">UIElement</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name">BindingExpressionBase</span> <span class="token function">SetBinding</span><span class="token punctuation">(</span><span class="token class-name">DependencyProperty</span> dp<span class="token punctuation">,</span> <span class="token class-name">BindingBase</span> binding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> BindingOperations<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> dp<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>现在我们使用的依赖属性靠GetValue、SetValue进行对外界的暴露，我们可以为依赖属性添加一个CLR属性外包装：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name <span class="token punctuation">{</span>
        <span class="token keyword keyword-get">get</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword keyword-string">string</span><span class="token punctuation">)</span><span class="token function">GetValue</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>NameProperty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-set">set</span> <span class="token operator">=&gt;</span> <span class="token function">SetValue</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>NameProperty<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p>我们知道，依赖对象可通过Binding依赖在其它对象上，即依赖对象是作为数据的目标存在的。现在我们为依赖对象的依赖属性添加了CLR属性包装，就相当于为依赖对象准备了用于暴露数据的Binding Path。也就是说，现在的依赖对象新增了扮演数据源的能力。尽管Student类没有实现INotifyPropertyChanged接口，但当属性值发生改变时，与之关联的Binding对象依然可以得到通知，依赖属性默认带有这样的功能，天生就是合格的数据源。</p>
<p>我们再升级一下，添加SetBinding方法：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">Student</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DependencyObject</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-readonly">readonly</span> <span class="token class-name">DependencyProperty</span> NameProperty <span class="token operator">=</span> DependencyProperty<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token string">"Name"</span><span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword keyword-string">string</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Student</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name <span class="token punctuation">{</span>
            <span class="token keyword keyword-get">get</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token keyword keyword-string">string</span><span class="token punctuation">)</span><span class="token function">GetValue</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>NameProperty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-set">set</span> <span class="token operator">=&gt;</span> <span class="token function">SetValue</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>NameProperty<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name">BindingExpressionBase</span> <span class="token function">SetBinding</span><span class="token punctuation">(</span><span class="token class-name">DependencyProperty</span> dp<span class="token punctuation">,</span> <span class="token class-name">BindingBase</span> binding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> BindingOperations<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> dp<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>将stu依赖到txtBox1上，再将txtBox2依赖到stu上，形成一条Binding链：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"Text"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Source <span class="token operator">=</span> txtBox1 <span class="token punctuation">}</span><span class="token punctuation">;</span>
    BindingOperations<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>_stu<span class="token punctuation">,</span> Student<span class="token punctuation">.</span>NameProperty<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Binding</span> binding2 <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"Name"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Source <span class="token operator">=</span> _stu <span class="token punctuation">}</span><span class="token punctuation">;</span>
    txtBox2<span class="token punctuation">.</span><span class="token function">SetBinding</span><span class="token punctuation">(</span>TextBox<span class="token punctuation">.</span>TextProperty<span class="token punctuation">,</span> binding2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>实际上定义依赖属性时直接输入propdp，即可自动生成注册代码。</p>
<h3 id="依赖属性值存取的秘密">依赖属性值存取的秘密 </h3>
<p>调用依赖对象的SetValue方法时，值被存储到哪里了？先来研究DependencyProperty.Register方法注册的DependencyProperty实例在哪里。F12查看相关代码，可以发现DependencyProperty类中有这样的成员：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-static">static</span> <span class="token class-name">Hashtable</span> PropertyFromName <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>TODO：未细看</p>
<h2 id="附加属性attached-properties">附加属性(Attached Properties) </h2>
<p>顾名思义，附加属性是说一个属性本来不属于某个对象，但由于某种需求而被后来附加上，也就是把对象放入一个特定环境后，对象才具有的属性称为附加属性。例如TextBox放入Grid中，可获得Grid.Row、Grid.Column属性。TextBox的作者不知道控件发布后被放在Grid中还是DockPanel中，所以不可能给TextBox添加Row、Column等属性。那就让布局决定一个TextBox用什么来设置它的位置吧，放在Gird中就让Gird给它附加上Row、Column属性，放在Dockpanel中就让Dockpanel给它附加上Dock属性，放在Canvas中就让Canvas给它附加上Left、Top、Right、Bottom属性。可见附加属性的作用就是让属性与数据类型(宿主)解耦，让数据类型的设计更加灵活。</p>
<p>附加属性本质上就是依赖属性，输入propa可自动创建相关代码：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">School</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DependencyObject</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token return-type class-name"><span class="token keyword keyword-int">int</span></span> <span class="token function">GetGrade</span><span class="token punctuation">(</span><span class="token class-name">DependencyObject</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span><span class="token punctuation">)</span>obj<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>GradeProperty<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">SetGrade</span><span class="token punctuation">(</span><span class="token class-name">DependencyObject</span> obj<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-int">int</span></span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            obj<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span>GradeProperty<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Using a DependencyProperty as the backing store for Grade.  This enables animation, styling, binding, etc...</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-readonly">readonly</span> <span class="token class-name">DependencyProperty</span> GradeProperty <span class="token operator">=</span>
            DependencyProperty<span class="token punctuation">.</span><span class="token function">RegisterAttached</span><span class="token punctuation">(</span><span class="token string">"Grade"</span><span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword keyword-int">int</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">School</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">PropertyMetadata</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p>如何消费School的GradeProperty呢？我们先创建一个派生自DependencyObject的类：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">Human</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">DependencyObject</span></span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-partial">partial</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Window</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            

            <span class="token class-name">Human</span> human <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Human</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            School<span class="token punctuation">.</span><span class="token function">SetGrade</span><span class="token punctuation">(</span>human<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword keyword-int">int</span></span> grade <span class="token operator">=</span> School<span class="token punctuation">.</span><span class="token function">GetGrade</span><span class="token punctuation">(</span>human<span class="token punctuation">)</span><span class="token punctuation">;</span>
            MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>grade<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//3</span>
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span>
</code></pre><p>附加属性本质是依赖属性，所以也支持绑定，下例用两个Slider控制Rectangle在Canvas上的横纵坐标：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Canvas</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Slider</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider1<span class="token punctuation">"</span></span> <span class="token attr-name">Minimum</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">Maximum</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">Canvas.Left</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">Canvas.Top</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>200<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Slider</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slider2<span class="token punctuation">"</span></span> <span class="token attr-name">Minimum</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">Maximum</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span> <span class="token attr-name">Canvas.Left</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">Canvas.Top</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>40<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>200<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Rectangle</span> <span class="token attr-name">Canvas.Left</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding ElementName=slider1,Path=Value}<span class="token punctuation">"</span></span> 
                   <span class="token attr-name">Canvas.Top</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding ElementName=slider2, Path=Value}<span class="token punctuation">"</span></span>
                   <span class="token attr-name">Fill</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Red<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>30<span class="token punctuation">"</span></span> <span class="token attr-name">Height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>30<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Rectangle</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Canvas</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-02-28-15-41-17.png" alt=""></p>
<h1 id="深入浅出话事件">深入浅出话事件 </h1>
<p>就像属性在WPF中进化为依赖属性一样，事件也进化为路由事件(Routed Event)，并在其基础上衍生出命令传递机制。这些机制在很大程度上减少了对程序员的束缚，让程序的设计和实现更加灵活，模块之间的耦合度也进一步降低。</p>
<h2 id="近观wpf的树形结构">近观WPF的树形结构 </h2>
<p>路由一词大意是这样：起点与终点间有若干个中转站，从起点出发后经过每个中转站都要做出选择，最终以正确(比如最短或最快)的路径到达终点。可以把WPF的路由事件看成是一只小蚂蚁，它可以从树的基部向顶部爬行，或反向爬行，每路过一棵树的分叉点就会把消息带给这个分叉点。</p>
<p>WPF中有两种树：</p>
<ul>
<li>
<p>逻辑树(Logical Tree)：完全由布局组件和控件构成，包括列表控件中的条目元素，换句话说，它的每个节点不是布局组件就是控件。</p>
</li>
<li>
<p>可视元素树(Visual Tree)：每个WPF控件本身也是一棵由更细微级别的组件构成的树，这些更细微级别的组件并非控件，派生自Visual类。可使用Blend解剖并观察一个控件的模板(Template)是怎样的。一个路由事件被激发后沿着Visual Tree传递，只有这样，“藏”在Template里的控件才能把消息送出来。</p>
</li>
</ul>
<p>大多数情况下我们是在与Logical Tree打交道，如果你的程序需要借助Visual Tree来完成一些业务逻辑(而不是纯表现逻辑)，那么多半是由程序设计不良造成的，请重新考虑逻辑、功能、数据类型方面的设计。</p>
<p>如果想在Logical Tree上导航或查找元素，可借助LogicalTreeHelper类的static方法：</p>
<ul>
<li>BringIntoView：把选定元素带进用户可视区域，经常用于可滚动的视图。</li>
<li>FindLogicalNode：按给定名称(Name属性值)查找元素，包括子级树上的元素。</li>
<li>GetChildren：获取所有直接子元素。</li>
<li>GetParent：获取直接父元素。</li>
</ul>
<p>如果想在Visual Tree上导航或查找元素，可借助VisualTreeHelper类的static方法，具体请查阅MSDN。</p>
<p>Logical Tree和Visual Tree的区别在后面讲述资源时还会提到。</p>
<h2 id="事件的来龙去脉">事件的来龙去脉 </h2>
<p>随着面向对象开发平台的日趋成熟，微软把消息机制封装成了更容易让人理解的事件模型。事件模型隐藏了消息机制的很多细节，让程序开发变得简单，繁琐的消息机制在事件模型中被简化为3个关键点：</p>
<ul>
<li>
<p>事件的拥有者：即消息的发送者。事件的宿主可以在某些条件下激发它拥有的事件，即事件被触发。事件被触发即消息被发送。</p>
</li>
<li>
<p>事件的响应者：即消息的接收者、处理者。它使用事件处理器(Event Handler)对事件做出相应。</p>
</li>
<li>
<p>事件的订阅关系：事件拥有者可以随时激发事件，但会不会响应要看是否有事件的响应者。如果对象A关注对象B的某个事件，则称A订阅了B的事件。事件实际上是一个使用event关键字修饰的委托(Delegate)类型成员变量。事件处理器则是一个函数，A订阅了B的事件，本质上就是B.Event与A.EventHandler产生了关联。事件激发就是B.Event被调用，这时与其关联的A.EventHandler就会被调用。</p>
</li>
</ul>
<p>在这种模型里，事件响应者通过订阅关系直接关联在事件拥有者的事件上。为了与WPF的路由事件模型区分开，我们把这种事件模型称为直接事件模型或CLR事件模型。</p>
<h2 id="深入浅出路由事件">深入浅出路由事件 </h2>
<p>路由事件中的事件拥有者和事件响应者没有直接显示的订阅关系，事件拥有者只负责激发事件，事件将由谁响应它并不关心。事件响应者则安装有事件侦听器，当有事件传递进来时就可以用事件处理器来响应事件，并决定事件是否可以继续传递。例如Visual Tree上有一个Button，当它被单击后就相当于喊了一声“我被单击了”，这样一个Button.Click事件就开始在Visual Tree传播，当事件经过某个节点时，如果这个节点没有安装侦听Button.Click事件的侦听器，那么节点会无视该事件，让它继续传播，否则节点的事件处理器就会被调用。侦听者并不关心具体哪个Button.Click事件被传来，即任何一个Button.Click事件都会被侦听到。在事件处理器内程序员可以查看路由事件原始出发点是哪个控件、上一站是哪里，还可以决定事件传递到此为止还是继续传递。</p>
<p>顺便说一句，WPF任然支持传统的直接事件模型，本节我们先看看内置路由事件的使用，再谈如何使用自定义路由事件。</p>
<h3 id="使用wpf内置路由事件">使用WPF内置路由事件 </h3>
<p>WPF中大多数事件都是可路由事件，我们以Button的Click事件来说明路由事件的使用：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel<span class="token punctuation">"</span></span> <span class="token attr-name">Button.Click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Button_Click<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DockPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dockPanel<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>grid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>OK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DockPanel</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token punctuation">(</span>sender <span class="token keyword keyword-as">as</span> <span class="token class-name">FrameworkElement</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string"> "</span></span> <span class="token operator">+</span>
            <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token punctuation">(</span>e<span class="token punctuation">.</span>OriginalSource <span class="token keyword keyword-as">as</span> <span class="token class-name">FrameworkElement</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-03-01-12-01-23.png" alt=""></p>
<p>这里我们把Button.Click事件定义在StackPanel中，在XAML编辑器中输入Button.时不会得到提示，直到输入=后才给出提示。但如果使用ButtonBase就能获得提示，因为ClickEvent这个路由事件是在ButtonBase中定义的，并用了Click事件进行了封装。</p>
<p>在上例中，因为Click路由事件是从内部一层一层向上冒泡到最外层的StackPanel，并由StackPanel将消息交给Button_Click方法来处理的，所以sender是StackPanel，e.OriginalSource才是Button。</p>
<p>也可以用代码设置事件处理器：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    stackPanel<span class="token punctuation">.</span><span class="token function">AddHandler</span><span class="token punctuation">(</span>Button<span class="token punctuation">.</span>ClickEvent<span class="token punctuation">,</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">RoutedEventHandler</span><span class="token punctuation">(</span>Button_Click<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>AddHandler的第1个参数是静态字段Button.ClickEvent，原来WPF的事件系统也使用了与属性系统相似的封装方法：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-abstract">abstract</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">ButtonBase</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ContentControl</span><span class="token punctuation">,</span> <span class="token class-name">ICommandSource</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-readonly">readonly</span> <span class="token class-name">RoutedEvent</span> ClickEvent<span class="token punctuation">;</span>

        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-event">event</span> <span class="token return-type class-name">RoutedEventHandler</span> Click <span class="token punctuation">{</span>
            <span class="token keyword keyword-add">add</span> <span class="token punctuation">{</span>
                <span class="token function">AddHandler</span><span class="token punctuation">(</span>ClickEvent<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-remove">remove</span> <span class="token punctuation">{</span>
                <span class="token function">RemoveHandler</span><span class="token punctuation">(</span>ClickEvent<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-virtual">virtual</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">OnClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RoutedEventArgs</span> e <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">RoutedEventArgs</span><span class="token punctuation">(</span>ClickEvent<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">RaiseEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><h3 id="自定义路由事件">自定义路由事件 </h3>
<p>为了方便程序中对象之间的通信，我们常需要自定义一些路由事件，说实话，在程序中使用这种能够在对象间“飞来飞去”的事件，不再受直接事件(那种必须手动把事件一层层向外传)束缚的感觉确实很棒。创建自定义路由事件大体分为3个步骤：</p>
<ol>
<li>定义并注册路由事件</li>
<li>为路由事件添加CLR包装</li>
<li>创建可以激发路由事件的方法</li>
</ol>
<p>定义路由事件与定义依赖属性的手法极其相似，看ButtonBase类中注册路由事件的代码：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-readonly">readonly</span> <span class="token class-name">RoutedEvent</span> ClickEvent <span class="token operator">=</span> 
            EventManager<span class="token punctuation">.</span><span class="token function">RegisterRoutedEvent</span><span class="token punctuation">(</span><span class="token string">"Click"</span><span class="token punctuation">,</span> RoutingStrategy<span class="token punctuation">.</span>Bubble<span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">RoutedEventHandler</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ButtonBase</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>第1个参数是路由事件的名称，按照微软的建议，这个字符串应该与RoutedEvent类型变量的前缀和CLR事件包装器的名称一致。<br>
第2个参数是路由事件的策略，取值有3种：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-enum">enum</span> <span class="token class-name">RoutingStrategy</span> <span class="token punctuation">{</span>
        Tunnel<span class="token punctuation">,</span> <span class="token comment">//隧道式，路由事件由UI树的树根向事件激发控件移动。</span>
        Bubble<span class="token punctuation">,</span> <span class="token comment">//冒泡式，路由事件由事件激发者出发向它的上级容器一层层路由，直至最外层容器。</span>
        Direct  <span class="token comment">//直达式，模仿CLR直达事件，直接将事件消息送达事件处理器。</span>
    <span class="token punctuation">}</span>
</code></pre><p>第3个参数是事件处理器的类型。<br>
第4个参数是路由事件的宿主(拥有者)类型。</p>
<p>下面我们自己创建一个路由事件，这个事件的用途是报告事件发生的时间：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token comment">//为了让事件消息携带时间数据，这里创建了一个类</span>
    <span class="token keyword keyword-class">class</span> <span class="token class-name">ReportTimeEventArgs</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">RoutedEventArgs</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name">DateTime</span> ClickTime <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token function">ReportTimeEventArgs</span><span class="token punctuation">(</span><span class="token class-name">RoutedEvent</span> routedEvent<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-object">object</span></span> source<span class="token punctuation">,</span> <span class="token class-name">DateTime</span> dateTime<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword keyword-base">base</span><span class="token punctuation">(</span>routedEvent<span class="token punctuation">,</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ClickTime <span class="token operator">=</span> dateTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-class">class</span> <span class="token class-name">TimeButton</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Button</span></span> <span class="token punctuation">{</span>
        <span class="token comment">//注意这里参数3的类型</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-readonly">readonly</span> <span class="token class-name">RoutedEvent</span> ReportTimeEvent <span class="token operator">=</span> 
            EventManager<span class="token punctuation">.</span><span class="token function">RegisterRoutedEvent</span><span class="token punctuation">(</span><span class="token string">"ReportTime"</span><span class="token punctuation">,</span> RoutingStrategy<span class="token punctuation">.</span>Bubble<span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EventHandler<span class="token punctuation">&lt;</span>ReportTimeEventArgs<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">TimeButton</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-event">event</span> <span class="token return-type class-name">RoutedEventHandler</span> ReportTime <span class="token punctuation">{</span>
            <span class="token keyword keyword-add">add</span> <span class="token punctuation">{</span>
                <span class="token function">AddHandler</span><span class="token punctuation">(</span>ReportTimeEvent<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-remove">remove</span> <span class="token punctuation">{</span>
                <span class="token function">RemoveHandler</span><span class="token punctuation">(</span>ReportTimeEvent<span class="token punctuation">,</span> <span class="token keyword keyword-value">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-protected">protected</span> <span class="token keyword keyword-override">override</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">OnClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-base">base</span><span class="token punctuation">.</span><span class="token function">OnClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//保证Button原有功能正常、CLR事件能被激发</span>
            <span class="token class-name">ReportTimeEventArgs</span> e <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">ReportTimeEventArgs</span><span class="token punctuation">(</span>ReportTimeEvent<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">RaiseEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-partial">partial</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Window</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">TimeButton_ReportTime</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">ReportTimeEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lstBox<span class="token punctuation">.</span>Items<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">e<span class="token punctuation">.</span>ClickTime</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token punctuation">(</span>sender <span class="token keyword keyword-as">as</span> <span class="token class-name">FrameworkElement</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>从最内层的TimeButton到最外层的StackPanel都侦听TimeButton.ReportTime这个路由事件：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel1<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">local:</span>TimeButton.ReportTime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TimeButton_ReportTime<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel2<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">local:</span>TimeButton.ReportTime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TimeButton_ReportTime<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel3<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">local:</span>TimeButton.ReportTime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TimeButton_ReportTime<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>TimeButton</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>timeButton<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">local:</span>TimeButton.ReportTime</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TimeButton_ReportTime<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Time<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">local:</span>TimeButton</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lstBox<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox</span><span class="token punctuation">&gt;</span></span>                
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>单击按钮，效果如下：<br>
<img src="2023-03-01-16-22-28.png" alt=""></p>
<p>如果将TimeButton类中注册时的RoutingStrategy.Bubble改为RoutingStrategy.Tunnel，效果如下：<br>
<img src="2023-03-01-16-27-37.png" alt=""></p>
<p>再将其改为RoutingStrategy.Direct，则每次点击只会由TimeButton触发一次：<br>
<img src="2023-03-01-16-28-12.png" alt=""></p>
<p>RoutedEventArgs有一个Handled属性，一旦被设置为true，就表示路由事件已经被处理了，不需要继续传递。</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">TimeButton_ReportTime</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">ReportTimeEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lstBox<span class="token punctuation">.</span>Items<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">e<span class="token punctuation">.</span>ClickTime</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token punctuation">(</span>sender <span class="token keyword keyword-as">as</span> <span class="token class-name">FrameworkElement</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>sender <span class="token operator">==</span> stackPanel2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>Handled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>   <span class="token comment">//路由事件传到stackPanel2就停止传递</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><h3 id="routedeventargs的source与originalsource">RoutedEventArgs的Source与OriginalSource </h3>
<p>RoutedEventArgs有两个属性，他们是Source与OriginalSource，这两个属性都表示路由事件的传递起点，也就是事件消息的源头，二者区别如下：</p>
<ul>
<li>Source：表示Logical Tree上的消息源头。</li>
<li>OriginalSource：表示Visual Tree上的消息源头。</li>
</ul>
<p>看下面的列子，右键项目-添加-用户界面控件，文件名设为MyUserControl.xaml，代码如下：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserControl</span> <span class="token attr-name"><span class="token namespace">x:</span>Class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Net4._8WpfApp1.MyUserControl<span class="token punctuation">"</span></span>
                <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml/presentation<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">xmlns:</span>x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">xmlns:</span>mc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.openxmlformats.org/markup-compatibility/2006<span class="token punctuation">"</span></span> 
                <span class="token attr-name"><span class="token namespace">xmlns:</span>d</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/expression/blend/2008<span class="token punctuation">"</span></span> 
                <span class="token attr-name"><span class="token namespace">xmlns:</span>local</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:Net4._8WpfApp1<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">mc:</span>Ignorable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>d<span class="token punctuation">"</span></span> 
                <span class="token attr-name"><span class="token namespace">d:</span>DesignHeight</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>450<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">d:</span>DesignWidth</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>800<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Border</span> <span class="token attr-name">BorderBrush</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Orange<span class="token punctuation">"</span></span> <span class="token attr-name">BorderThickness</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span> <span class="token attr-name">CornerRadius</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>innerButton<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>OK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Border</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>UserControl</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>然后回到主窗口的xaml中消费这个自定义控件，还添加了对ButtonBase.Click路由事件的侦听：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel1<span class="token punctuation">"</span></span> <span class="token attr-name">ButtonBase.Click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ButtonBase_Click<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>MyUserControl</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">local:</span>MyUserControl</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">ButtonBase_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">e<span class="token punctuation">.</span>Source</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Environment<span class="token punctuation">.</span>NewLine</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">e<span class="token punctuation">.</span>OriginalSource</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-03-01-16-50-38.png" alt=""></p>
<p>ButtonBase.Click路由事件是从MyUserControl的innerButton发出来的，在主窗口中，MyUserControl是Logical Tree的末端终点，所以e.Source就是MyUserControl类的实例。而Visual Tree包含了MyUserControl的内部结构，所以e.OriginalSource可以获得innerButton。</p>
<h3 id="事件也附加深入浅出附加事件">事件也附加——深入浅出附加事件 </h3>
<p>WPF事件系统中还有一种事件被称为附加事件(Attached Event)，它其实就是路由事件。以下这些类有附加事件：</p>
<ul>
<li>Binding类：SourceUpdated事件、TargetUpdated事件。</li>
<li>Mouse类：MouseEnter、MouseLeave、MouseDown、MouseUp事件等。</li>
<li>Keyboard类：KeyDown、KeyUp事件等。</li>
</ul>
<p>拥有路由事件的宿主如Button、TextBox、Slider等都是拥有可视化实体的界面元素，而附加事件的宿主不具备显示在用户界面上的能力。</p>
<p>看下面的例子，设计了一个Student类，如果Student类实例的Name属性变化了就激发一个路由事件，我们会使用界面元素捕捉这个事件：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stackPanel1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">Click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Button_Click<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>OK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-readonly">readonly</span> <span class="token class-name">RoutedEvent</span> NameChangedEvent <span class="token operator">=</span> 
            EventManager<span class="token punctuation">.</span><span class="token function">RegisterRoutedEvent</span><span class="token punctuation">(</span><span class="token string">"NameChanged"</span><span class="token punctuation">,</span> RoutingStrategy<span class="token punctuation">.</span>Bubble<span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">EventHandler<span class="token punctuation">&lt;</span>RoutedEvent<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword keyword-typeof">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Student</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-int">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-string">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-partial">partial</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">MainWindow</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Window</span></span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//添加路由事件侦听器</span>
            stackPanel1<span class="token punctuation">.</span><span class="token function">AddHandler</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>NameChangedEvent<span class="token punctuation">,</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">RoutedEventHandler</span><span class="token punctuation">(</span>StudentNameChangedHandler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">StudentNameChangedHandler</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token punctuation">(</span>e<span class="token punctuation">.</span>OriginalSource <span class="token keyword keyword-as">as</span> <span class="token class-name">Student</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Id</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Student</span> stu <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> Name <span class="token operator">=</span> <span class="token string">"Jack"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            stu<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"Tom"</span><span class="token punctuation">;</span>
            <span class="token class-name">Button</span> btn <span class="token operator">=</span> <span class="token punctuation">(</span>Button<span class="token punctuation">)</span>sender<span class="token punctuation">;</span>
            btn<span class="token punctuation">.</span><span class="token function">RaiseEvent</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">RoutedEventArgs</span><span class="token punctuation">(</span>Student<span class="token punctuation">.</span>NameChangedEvent<span class="token punctuation">,</span> stu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-03-01-17-44-37.png" alt=""></p>
<p>由于Student不是UIElement的派生类，所以它不具备RaiseEvent方法，为了发送路由事件只好借用以下Button的RaiseEvent方法。</p>
<p>TODO：后面没细看</p>
<h1 id="深入浅出话命令">深入浅出话命令 </h1>
<p>有了路由事件为何还要命令系统呢？事件的作用是发布、传播一些消息，每个事件响应者都可以用自己的行为来响应事件，也就是说，事件不具有约束力。但命令具有约束力，当在vs中点击文件-全部保存时，所有打开的文档都会执行Save()方法。当Save命令到达某个组件时，命令会主动调用组件的Save方法，这个方法可能被定义在基类或接口里，从而保证这个方法一定存在，这就在代码结构和命名上做了约束。命令除了约束代码，还可以约束步骤，例如命令可控制接收者“先校验、再保存、最后关闭”，因此命令可以帮助我们降低成本。</p>
<h2 id="命令系统的基本元素与关系">命令系统的基本元素与关系 </h2>
<h3 id="命令系统的基本元素">命令系统的基本元素 </h3>
<p>WPF命令系统由以下基本要素组成：</p>
<ul>
<li>
<p>命令(Command)：WPF的命令实际上就是实现了ICommand接口的类，使用最多的是RoutedCommand类。我们还会学习使用自定义命令。</p>
</li>
<li>
<p>命令源(Command Source)：命令的发送者，是实现了ICommandSource接口的类。很多界面元素都实现了该接口，例如Button、ListBoxItem、MenuItem。</p>
</li>
<li>
<p>命令目标(Command Target)：命令将发送给谁，或者说命令将作用在谁身上，是实现了IInputElement接口的类。</p>
</li>
<li>
<p>命令关联(Command Binding)：负责把一些外围逻辑与命令关联起来，例如执行前判断是否可执行命令、命令执行后还有哪些后续工作。</p>
</li>
</ul>
<h3 id="基本元素之间的关系">基本元素之间的关系 </h3>
<h1 id="深入浅出话资源">深入浅出话资源 </h1>
<p>WPF不但支持传统的二进制资源，还推出了独具特色的对象级资源，每个界面元素都可以携带自己的资源并可被子级元素共享，例如各种模板、样式、主题经常放在对象级资源里。</p>
<h2 id="wpf对象级资源的定义与查找">WPF对象级资源的定义与查找 </h2>
<p>FrameworkElement有一个名为Resources的属性，其类型为ResourceDictionary。由于继承关系，每个WPF界面元素也有了这个属性。ResourceDictionary能够以“键值对”的形式存储资源。在保存资源时，ResourceDictionary视资源对象为object类型，因此使用资源时要先进行类型转换。XAML编译器能根据标签的Attribute自动识别类型，如果类型不对会抛异常，C#代码中就需要我们自己转换了。</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-public">public</span> <span class="token return-type class-name">ResourceDictionary</span> Resources <span class="token punctuation">{</span>
        <span class="token keyword keyword-get">get</span> <span class="token punctuation">{</span>
            <span class="token comment">//...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-set">set</span> <span class="token punctuation">{</span>
            <span class="token comment">//...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p>看下面的例子：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ResourceDictionary</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">sys:</span>String</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myString<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Hello World<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">sys:</span>String</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">sys:</span>Double</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myDbl<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>3.14<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">sys:</span>Double</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ResourceDictionary</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>


    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">Content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{StaticResource myString}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!--Button的Content类型是object，所以编译成功--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn<span class="token punctuation">"</span></span> <span class="token attr-name">Content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{StaticResource myDbl}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
        
        <span class="token comment">&lt;!--TextBlock的Text类型是string，所以编译失败--&gt;</span>
        <span class="token comment">&lt;!--&lt;TextBlock Text="{StaticResource myDbl}"&gt;&lt;/TextBlock&gt;--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>也可以用C#代码实现：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    btn<span class="token punctuation">.</span>Content <span class="token operator">=</span> <span class="token function">FindResource</span><span class="token punctuation">(</span><span class="token string">"myDbl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//如果明确知道在哪个对象的Resources里，也可以这样写</span>
    btn<span class="token punctuation">.</span>Content <span class="token operator">=</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>Resources<span class="token punctuation">[</span><span class="token string">"myDbl"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><p><img src="2023-03-01-19-06-33.png" alt=""></p>
<p>在检索资源时，首先检索控件自己的Resources属性，如果没有就沿着Logical Tree一层层往上找；如果最顶层容器也没有，那么就检索Application.Resource；如果还没有找到，就会抛异常。</p>
<p>如果想利用别人写好的的WPF资源，例如一组漂亮的皮肤，可以将XAML文件添加进项目并使用ResourceDictionary的Source属性进行引用：</p>
<pre data-role="codeBlock" data-info="xaml" class="language-xaml xaml"><code>    &lt;Window.Resources&gt;
        &lt;ResourceDictionary Source="example.xaml"&gt;
        &lt;/ResourceDictionary&gt;        
    &lt;/Window.Resources&gt;
</code></pre><h2 id="静态资源和动态资源">静态资源和动态资源 </h2>
<p>当资源被存储进资源字典后，我们可以使用静态方式或动态方式使用资源。</p>
<ul>
<li>
<p>静态资源：使用StaticResource，在程序载入内存时对资源一次性使用，之后不再访问该资源。如果程序的皮肤在运行中始终不变，可采用静态资源的方式。</p>
</li>
<li>
<p>动态资源：使用DynamicResource，在程序运行过程中仍然会去访问资源。如果允许用户在程序运行过程中改变程序皮肤，就必须采用动态资源的方式。</p>
</li>
</ul>
<p>下例用StaticResource和DynamicResource的方式使用了资源：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>res1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>aaa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBlock</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>res2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>bbb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBlock</span><span class="token punctuation">&gt;</span></span>     
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">Content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{StaticResource res1}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">Content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{DynamicResource res2}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">Click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Button_Click<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>OK<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-private">private</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Button_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-object">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">RoutedEventArgs</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>Resources<span class="token punctuation">[</span><span class="token string">"res1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">TextBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Text <span class="token operator">=</span> <span class="token string">"new aaa"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>Resources<span class="token punctuation">[</span><span class="token string">"res2"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">TextBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Text <span class="token operator">=</span> <span class="token string">"new bbb"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p>刚运行时如下：<br>
<img src="2023-03-01-19-36-55.png" alt=""></p>
<p>点击OK按钮后如下：<br>
<img src="2023-03-01-19-37-02.png" alt=""></p>
<p>第1个按钮以静态方式使用资源，所以尽管资源更新了，它也不知道。第2个按钮以动态方式使用资源，它可以感知到变化。</p>
<h2 id="使用pack-uri路径访问资源">使用Pack URI路径访问资源 </h2>
<p>Pack URI路径访问资源的格式为：<br>
<code>pack://application,,,[/程序集名;][/可选版本号;][/文件夹名;]文件名</code></p>
<p>实际上pack://application,,,可以省略，程序集名、可选版本号常使用默认值，因此只剩下这个了：<br>
<code>[/文件夹名;]文件名</code></p>
<p>例如我们右键项目添加一个名为Images的文件夹，在该文件夹内放入一张名为vs.png的图片。再放入一张vscode.png的图片，它不在Images文件夹里，而是直接在项目下。右键图片文件-属性，生成操作选“Resource”，复制到输出目录选“不复制”。访问方法如下：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Image</span> <span class="token attr-name">Source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/Images/vs.png<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Image</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Image</span> <span class="token attr-name">Source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Images/vs.png<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Image</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Image</span> <span class="token attr-name">Source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/vscode.png<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Image</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Image</span> <span class="token attr-name">Source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vscode.png<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Image</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>如果用代码设置，方法如下：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    image1<span class="token punctuation">.</span>Source <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">BitmapImage</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">@"/Images/vs.png"</span><span class="token punctuation">,</span> UriKind<span class="token punctuation">.</span>Relative<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    image2<span class="token punctuation">.</span>Source <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">BitmapImage</span><span class="token punctuation">(</span><span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">@"/vscode.png"</span><span class="token punctuation">,</span> UriKind<span class="token punctuation">.</span>Relative<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><img src="2023-03-01-20-00-17.png" alt=""></p>
<p>使用Pack URI路径时注意以下几点：</p>
<ul>
<li>Pack URI使用正斜杠(/)表示路径。TODO：实测反斜杠也可以，甚至混用都可以。</li>
<li>使用缩略写法意味着相对路径，因此C#代码中必须为UriKind.Relative，而且代表根目录的正斜杠(/)可以省略。此时./代表同级目录，../代表父目录。</li>
<li>使用完整写法意味着绝对路径，因此C#代码中必须为UriKind.Absolute，而且代表根目录的正斜杠(/)不可以省略。</li>
</ul>
<h1 id="深入浅出话模板">深入浅出话模板 </h1>
<h2 id="模板的内涵">模板的内涵 </h2>
<p>WPF通过引入模板(Template)将数据和算法的“内容”和“形式”解耦了，Template分为两类：</p>
<ul>
<li>ControlTemplate：算法内容的表现形式，它决定了控件长成什么样子，程序员也可以扩展控件原有的内部逻辑。</li>
<li>DateTemplate：数据内容的表现形式，一条数据显示成简单的文本还是直观的图形动画就由它决定。</li>
</ul>
<p>一言以蔽之，Template就是外衣，ControlTemplate是控件的外衣，DateTemplate是数据的外衣。</p>
<p>WPF中的控件不再具有固定形象，仅仅是算法内容或数据内容的载体。可以把控件理解为一组操作逻辑穿上了一套衣服，换套衣服就能变成另一个模样。我们看到的默认控件形象实际上是出厂时微软为它穿上的默认衣服。</p>
<p>WPF中的数据显示成什么样也可以自由设定。下面的示例只是为数据条目准备了一个DataTemplate，在这个DataTemplate中用Binding把一个Rectangle的Width、一个TextBlock的Text关联到数据对象的Price上，把另一个TextBlock的Text关联到数据对象的Year上。一旦应用这个DataTemplate，简单的数据就变成了直观的柱状图。</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 当lstBox.ItemsSource被赋值时，ListBox会为每个条目穿上外衣，这件外衣就是ItemTemplate --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lstBox<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox.ItemTemplate</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataTemplate</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name">Orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Horizontal<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Rectangle</span> <span class="token attr-name">Fill</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Red<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Price}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Year}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Price}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DataTemplate</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox.ItemTemplate</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox</span><span class="token punctuation">&gt;</span></span>
        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name">DataContext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding ElementName=lstBox, Path=SelectedItem}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Year}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBlock</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Price}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBlock</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code>    <span class="token keyword keyword-class">class</span> <span class="token class-name">MyData</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-int">int</span></span> Year <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-double">double</span></span> Price <span class="token punctuation">{</span> <span class="token keyword keyword-get">get</span><span class="token punctuation">;</span> <span class="token keyword keyword-set">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword keyword-public">public</span> <span class="token function">MyData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-int">int</span></span> year<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-double">double</span></span> price<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Year <span class="token operator">=</span> year<span class="token punctuation">;</span>
            Price <span class="token operator">=</span> price<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-public">public</span> <span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        lstBox<span class="token punctuation">.</span>ItemsSource <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">ObservableCollection<span class="token punctuation">&lt;</span>MyData<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">MyData</span><span class="token punctuation">(</span><span class="token number">1990</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">MyData</span><span class="token punctuation">(</span><span class="token number">1991</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">MyData</span><span class="token punctuation">(</span><span class="token number">1992</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">MyData</span><span class="token punctuation">(</span><span class="token number">1993</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-new">new</span> <span class="token constructor-invocation class-name">MyData</span><span class="token punctuation">(</span><span class="token number">1994</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p><img src="2023-03-08-11-23-34.png" alt=""></p>
<h2 id="数据的外衣datatemplate">数据的外衣DataTemplate </h2>
<p>同样的数据可以用不同的形式来展现，软件设计称之为数据-视图(Data-View)模式。以往的开发技术，例如MFC，Winforms、ASP.NET等，视图要靠UserControl来实现。WPF不但支持UserControl，还支持用DataTemplate为数据形成视图。DataTemplate常用于以下3处：</p>
<ul>
<li>ContentControl的ContentTemplate属性：相当于给ContentControl的内容穿衣服。</li>
<li>ItemsControl的ItemTemplate属性：相当于给ItemsControl的数据条目穿衣服。</li>
<li>GridViewColumn的CellTemplate属性：相当于给GridViewColumn单元格里的数据穿衣服。</li>
</ul>
<p>下面将之前的例子稍作改造，展示ContentTemplate和ItemTemplate的使用。在项目上右键-添加-用户控件，新文件命名为MyUserControl1.xaml，其内容如下：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>UserControl</span> <span class="token attr-name"><span class="token namespace">x:</span>Class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Net4._8WpfApp1.MyUserControl1<span class="token punctuation">"</span></span>
             <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml/presentation<span class="token punctuation">"</span></span>
             <span class="token attr-name"><span class="token namespace">xmlns:</span>x</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/winfx/2006/xaml<span class="token punctuation">"</span></span>
             <span class="token attr-name"><span class="token namespace">xmlns:</span>mc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.openxmlformats.org/markup-compatibility/2006<span class="token punctuation">"</span></span> 
             <span class="token attr-name"><span class="token namespace">xmlns:</span>d</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.microsoft.com/expression/blend/2008<span class="token punctuation">"</span></span> 
             <span class="token attr-name"><span class="token namespace">xmlns:</span>local</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clr-namespace:Net4._8WpfApp1<span class="token punctuation">"</span></span>
             <span class="token attr-name"><span class="token namespace">mc:</span>Ignorable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>d<span class="token punctuation">"</span></span> 
             <span class="token attr-name"><span class="token namespace">d:</span>DesignHeight</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>450<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">d:</span>DesignWidth</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>800<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>UserControl</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>VS会帮我们在cs文件中生成部分类MyUserControl1，它继承自UserControl，UserControl又继承自ContentControl。我们在MyUserControl1.xaml文件中没有放置额外控件，因为会为其设置ContentTemplate。</p>
<p>MainWindow.xaml文件内容如下：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataTemplate</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myDataListItemTemplate<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name">Orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Horizontal<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Grid</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Rectangle</span> <span class="token attr-name">Fill</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Red<span class="token punctuation">"</span></span> <span class="token attr-name">Width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Price}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Year}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Grid</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Price}<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DataTemplate</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataTemplate</span> <span class="token attr-name"><span class="token namespace">x:</span>Key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myDataDetailTemplate<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Year}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBlock</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextBlock</span> <span class="token attr-name">Text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding Path=Price}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TextBlock</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DataTemplate</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Window.Resources</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- ItemTemplate的使用 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lstBox<span class="token punctuation">"</span></span> <span class="token attr-name">ItemTemplate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{StaticResource myDataListItemTemplate}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox</span><span class="token punctuation">&gt;</span></span>
        
        <span class="token comment">&lt;!-- ContentTemplate的使用 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">local:</span>MyUserControl1</span> <span class="token attr-name">ContentTemplate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{StaticResource myDataDetailTemplate}<span class="token punctuation">"</span></span> 
                              <span class="token attr-name">Content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{Binding ElementName=lstBox,Path=SelectedItem}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">local:</span>MyUserControl1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><h2 id="控件的外衣controltemplate">控件的外衣ControlTemplate </h2>
<p>在实际项目中，ControlTemplate主要用途如下：</p>
<ul>
<li>更换ControlTemplate改变控件外观，使之具有更优的使用体验。</li>
<li>借助ControlTemplate，程序员和设计师可并行工作，程序员可先使用标准WPF控件，需要时将新的ControlTemplate应用到程序中即可。</li>
</ul>
<p>如何为控件设计ControlTemplate呢？这需要了解每个控件的内部结构，在文档大纲上右键控件-编辑模板-编辑副本即可查看。对于复杂的控件，选择编辑副本后，可点击文档大纲上的“眼睛”图标显示或隐藏子控件。也可以使用Blend查看控件的内部结构，程序员可以将Blend理解为功能更强大的窗体设计器，设计师可以将Blend理解为会写XAML代码的PhotoShop。</p>
<h3 id="庖丁解牛看控件">庖丁解牛看控件 </h3>
<p>其实每个控件本身就是一棵UI元素树，WPF的UI元素可以看作两棵树，它们是Logical Tree和Visual Tree，这两棵树的交点就是ControlTemplate。如果把界面上的控件元素看作是一个节点，那么各元素构成的就是Logical Tree。如果把空间内部由ControlTemplate生成的控件也算上，那构成的就是Visual Tree。换句话说，在Logical Tree上导航不会进入到控件内部，在Visual Tree上导航则可检索到控件内部由ControlTemplate生成的控件。</p>
<h3 id="itemscontrol的paneltemplate">ItemsControl的PanelTemplate </h3>
<p>ItemsControl有一个名为ItemsPanel的属性，其数据类型为ItemsPanelTemplate。ItemsPanelTemplate也是一种控件Template，可以控制ItemsControl的条目容器。例如让ListBox中的条目水平排列：</p>
<pre data-role="codeBlock" data-info="xml" class="language-xml xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox</span> <span class="token attr-name"><span class="token namespace">x:</span>Name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lstBox<span class="token punctuation">"</span></span> <span class="token attr-name">DisplayMemberPath</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Year<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBox.ItemsPanel</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemsPanelTemplate</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StackPanel</span> <span class="token attr-name">Orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Horizontal<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemsPanelTemplate</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox.ItemsPanel</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBox</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StackPanel</span><span class="token punctuation">&gt;</span></span>
</code></pre><p><img src="2023-03-08-14-49-55.png" alt=""></p>
<h2 id="datatemplate与controltemplate的关系与应用">DataTemplate与ControlTemplate的关系与应用 </h2>
<h3 id="datatemplate与controltemplate的关系">DataTemplate与ControlTemplate的关系 </h3>
<p>现在应该可以体会到，控件只是个数据和行为的载体，是个抽象概念，至于它本身会长成什么样子(控件内部结构)、它的数据会长成什么样子(数据显示结构)，都是靠Template生成的。ControlTemplate决定控件外观，DataTemplate决定数据外观，它们正是Control类的Template和ContentTemplate两个属性的值。</p>
<p>凡是Template，最终都是要作用在控件上的，这个控件就是Template的目标控件，也叫模板化控件(Templated Control)。DataTemplate给人的感觉是作用在了数据对象上，实际上一般作用在ContentPresenter对象上。ContentPresenter只有ContentTemplate属性，而没有Template属性。</p>
<p>由ControlTemplate生成的控件树的树根就是ControlTemplate的目标控件，此模板化控件的Template属性值就是这个ControlTemplate实例。<br>
由DateTemplate生成的控件树的树根是一个ContentPresenter控件，此模板化控件的ContentTemplate属性值就是这个DateTemplate实例。<br>
因为ContentPresenter控件是ControlTemplate控件树上的一个节点，所以DataTemplate控件树是ControlTemplate控件树的一棵子树。</p>
<p>TODO：未细看</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>